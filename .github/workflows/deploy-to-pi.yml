      - name: Get and expand changed files
        id: changed
        run: |
          FILES=$(git diff --name-only HEAD^ HEAD || true)
          echo "$FILES" > files_raw.txt

          # Always include version.txt
          echo "version.txt" >> files_raw.txt

          echo "ðŸ”¹ Raw changed files:"
          cat files_raw.txt

          FILES_TO_UPLOAD=""
          DIRS_TO_CREATE=""
          while IFS= read -r path; do
            if [ -d "$path" ]; then
              # Track directory for mkdir, but DO NOT add to upload list
              DIRS_TO_CREATE="$DIRS_TO_CREATE $path"
              # Expand its files for upload
              for f in $(find "$path" -type f); do
                FILES_TO_UPLOAD="$FILES_TO_UPLOAD,$f"
              done
            elif [ -f "$path" ]; then
              FILES_TO_UPLOAD="$FILES_TO_UPLOAD,$path"
            fi
          done < files_raw.txt

          # Remove leading comma
          FILES_TO_UPLOAD="${FILES_TO_UPLOAD#,}"

          # Save outputs
          echo "files=$FILES_TO_UPLOAD" >> $GITHUB_OUTPUT
          echo "dirs=$DIRS_TO_CREATE" >> $GITHUB_ENV

          echo "ðŸ”¹ Files to upload:"
          echo "$FILES_TO_UPLOAD" | tr ',' '\n'
          echo "ðŸ”¹ Directories to create on Pi: $DIRS_TO_CREATE"

          # Detect Python file changes
          if echo "$FILES_TO_UPLOAD" | grep -Ei '\.py$'; then
            echo "py_changed=true" >> $GITHUB_ENV
          else
            echo "py_changed=false" >> $GITHUB_ENV
          fi
