<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Events Feed</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/css/base.css" />
  <style>
    body { touch-action: manipulation; }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #f6c553;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
  <div id="app">
    <header class="bg-blue-900 text-white flex items-center justify-between px-4 py-3 shadow-md">
      <div class="flex items-center space-x-4">
        <img v-if="tournamentLogo" :src="tournamentLogo" alt="Tournament Logo" class="h-14 drop-shadow">
        <span v-else class="text-white text-base">Loading Logo...</span>
      </div>
      <a href="/settings" class="border border-white text-white px-3 py-1 rounded hover:bg-white hover:text-blue-900 transition">Settings</a>
    </header>

    <div class="flex">
      <!-- Hooked Up Feed -->
      <div class="w-1/2 border-r border-gray-300 p-4">
        <h2 class="text-xl font-semibold mb-2">Hooked Up</h2>
        <div v-if="loading" class="flex justify-center items-center h-32"><div class="spinner"></div></div>
        <div v-else-if="hooked.length === 0" class="text-gray-500">No current hookups</div>
        <div v-else class="space-y-2">
          <div v-for="event in hooked" :key="event.timestamp + event.uid" class="p-3 bg-yellow-100 rounded flex items-center space-x-4">
            <img :src="getBoatImage(event.uid)" class="w-20 h-20 object-cover rounded" @error="hideOnError">
            <div>
              <div class="font-semibold">{{ event.boat }}</div>
              <div class="text-sm text-gray-700">{{ formatTime(event.timestamp) }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Event Feed -->
      <div class="w-1/2 p-4">
        <h2 class="text-xl font-semibold mb-2">Event Feed</h2>
        <div v-if="loading" class="flex justify-center items-center h-32"><div class="spinner"></div></div>
        <div v-else-if="events.length === 0" class="text-gray-500">No events to show.</div>
        <div v-else class="space-y-2">
          <div v-for="event in events" :key="event.timestamp + event.uid" class="p-3 bg-white rounded shadow flex items-center space-x-4">
            <img :src="getBoatImage(event.uid)" class="w-20 h-20 object-cover rounded" @error="hideOnError">
            <div>
              <div class="font-semibold">{{ event.boat }}</div>
              <div class="text-sm text-gray-700">{{ formatTime(event.timestamp) }} - {{ event.event }}</div>
              <div class="text-sm text-gray-600">{{ event.details }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const { createApp } = Vue
    createApp({
      data() {
        return {
          events: [],
          hooked: [],
          boatImages: {},
          loading: true,
          tournamentLogo: '',
          ready: false
        }
      },
      methods: {
        fetchAll() {
          this.loading = true

          Promise.all([
            fetch('/scrape/events').then(res => res.json()),
            fetch('/hooked').then(res => res.json()),
            fetch('/participants_data?limit=1000&offset=0').then(res => res.json()),
            fetch('/api/settings').then(res => res.json())
          ]).then(([eventsData, hookedData, participants, settings]) => {
            this.events = eventsData
            this.hooked = hookedData
            this.tournamentLogo = settings.logo

            const map = {}
            for (const p of participants) {
              map[p.uid] = p.image_path
            }
            this.boatImages = map
            this.ready = true

            // Trigger refresh to ensure image bindings update
            setTimeout(() => {
              this.events = this.events.map(e => ({ ...e }))
              this.hooked = this.hooked.map(e => ({ ...e }))
              this.loading = false
            }, 50)
          })
        },
        getBoatImage(uid) {
          return this.boatImages[uid] || '/static/images/boats/default.jpg'
        },
        formatTime(isoString) {
          const date = new Date(isoString)
          return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        },
        hideOnError(event) {
          event.target.style.display = 'none'
        }
      },
      mounted() {
        const waitForReady = () => {
          fetch('/status')
            .then(res => res.json())
            .then(status => {
              if (status.participants_cache_fresh && status.events_cache_fresh) {
                console.log('✅ Backend scrape ready — loading feed...')
                this.fetchAll()
              } else {
                console.log('⏳ Waiting for backend to finish scraping...')
                setTimeout(waitForReady, 2000)
              }
            })
        }
        waitForReady()
      }
    }).mount('#app')
  </script>
</body>
</html>
