<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Leaderboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Lobster&family=Montserrat:wght@700&family=Roboto:wght@400;500" rel="stylesheet"/>
  <link rel="stylesheet" href="/static/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
</head>
<body>
  <div id="app">
    <header>
      <img v-if="logoSrc" :src="logoSrc" alt="Tournament Logo" />
      <h1>Leaderboard</h1>
      <div class="control-buttons">
        <button class="settings-icon" @click="goBack">‚Üê Back</button>
      </div>
    </header>

    <div v-if="error" class="error">{{ error }}</div>

    <div v-if="isLoading" class="leaderboard">
      <div class="no-leaderboard">Loading leaderboard...</div>
    </div>

    <div v-else class="leaderboard">
      <div v-if="leaderboard.length > 0">
        <div v-for="entry in leaderboard" :key="entry.boat" class="leaderboard-item">
          <img
            :src="getBoatImage(entry.boat)"
            alt="Boat Image"
            class="boat-image"
            @error="handleImageError"
          />
          <span class="place">{{ entry.place || '' }}</span>
          <span class="boat-name">{{ entry.boat }}</span>
          <span class="score">{{ entry.points }}</span>
        </div>
      </div>
      <div v-else class="no-leaderboard">No leaderboard data available</div>
    </div>
  </div>

  <script>
    new Vue({
      el: '#app',
      data: {
        settings: {},
        allTournaments: {},
        leaderboard: [],
        participants: [],
        boatImages: {},
        error: null,
        isLoading: true,
        appMounted: false
      },
      computed: {
        logoSrc() {
          const t = this.settings?.tournament;
          const logo = this.allTournaments?.[t]?.logo;
          return logo || '/static/images/WHITELOGOBR.png';
        }
      },
      methods: {
        async loadSettings() {
          const res = await fetch('/settings');
          if (res.ok) this.settings = await res.json();
        },
        async loadTournamentSettings() {
          const res = await fetch('https://js9467.github.io/Brtourney/settings.json');
          if (res.ok) this.allTournaments = await res.json();
        },
        async loadParticipants() {
          try {
            const res = await fetch('/api/participants');
            if (!res.ok) throw new Error('Participants load failed');
            this.participants = await res.json();
            this.boatImages = this.participants.reduce((map, p) => {
              if (p.boat && p.image) {
                const key = p.boat.trim().toLowerCase();
                map[key] = p.image;
              }
              return map;
            }, {});
            console.log("‚úÖ Loaded participants:", this.boatImages);
          } catch (e) {
            console.error('‚ùå Failed to load participants:', e);
            this.boatImages = {};
          }
        },
        async loadLeaderboard() {
          try {
            const res = await fetch('/leaderboard');
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();

            // Normalize boat names by stripping size text and extra whitespace
            this.leaderboard = data.map(entry => {
              const cleanName = entry.boat.split('\n')[0].trim();
              return { ...entry, boat: cleanName };
            });

            console.log("‚úÖ Cleaned leaderboard entries:", this.leaderboard);
          } catch (e) {
            console.error("‚ùå Failed to load leaderboard:", e);
            this.error = 'Failed to load leaderboard: ' + e.message;
            this.leaderboard = [];
          }
        },
        getBoatImage(name) {
          if (!name) return '/static/images/placeholder.png';
          const key = name.trim().toLowerCase();
          const found = this.boatImages[key];
          if (!found) console.warn(`‚ùó No image found for boat: "${name}"`);
          return found || '/static/images/placeholder.png';
        },
        handleImageError(e) {
          e.target.src = '/static/images/placeholder.png';
        },
        goBack() {
          window.location.href = '/';
        }
      },
      async mounted() {
        try {
          console.log("üîÅ Loading leaderboard page...");
          await this.loadTournamentSettings();
          await this.loadSettings();
          await this.loadParticipants();
          await this.loadLeaderboard();
        } catch (e) {
          this.error = 'Initialization failed: ' + e.message;
          console.error(e);
        } finally {
          this.isLoading = false;
          this.appMounted = true;
          console.log("‚úÖ Leaderboard page mounted");
        }
      }
    });
  </script>
</body>
</html>
