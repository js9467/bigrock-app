<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leaderboard</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/css/base.css">
  <style>
    body { touch-action: manipulation; }
    .leaderboard-tile { transition: transform 0.2s; }
    .leaderboard-tile:hover { transform: scale(1.05); }
    .scroll-container { max-height: 65vh; overflow-y: auto; }
    .placeholder {
      text-align: center; 
      color: #888; 
      margin-top: 1rem;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans overflow-y-auto">
  <div id="app">
    <!-- Header -->
    <header class="bg-brand-blue text-white flex items-center justify-between px-6 py-3 shadow-md">
      <div class="flex items-center space-x-4">
        <img v-if="tournamentLogo" :src="tournamentLogo" alt="Tournament Logo" class="h-14 drop-shadow">
        <span v-else class="text-white text-base">Loading Logo...</span>
      </div>
      <a href="/" class="bg-white/10 hover:bg-white/20 rounded px-3 py-1 text-sm font-semibold">Back</a>
    </header>

    <div class="p-6">
      <!-- Top 3 -->
      <h2 class="text-xl font-bold mb-4 text-brand-blue">Top 3 Leaderboard</h2>
      <div v-if="loading" class="placeholder">Loading leaderboard...</div>
      <div v-else-if="top3.length" class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8">
        <div v-for="(entry, idx) in top3" :key="entry.uid || idx"
             class="bg-white rounded-lg shadow-md p-4 flex flex-col items-center leaderboard-tile">
          <img :src="getBoatImage(entry)" :alt="entry.boat"
               class="w-32 h-32 object-cover rounded-full border-4"
               :class="idx===0 ? 'border-yellow-400' : idx===1 ? 'border-gray-400' : 'border-orange-400'">
          <h3 class="mt-3 text-lg font-semibold text-center">{{ entry.boat || 'Unknown Boat' }}</h3>
          <p class="text-sm text-gray-600">{{ entry.points || 0 }} pts</p>
        </div>
      </div>
      <div v-else class="placeholder">No leaderboard data available.</div>

      <!-- Full Leaderboard -->
      <h2 class="text-xl font-bold mb-4 text-brand-blue">Full Leaderboard</h2>
      <div v-if="!loading && leaderboard.length" class="scroll-container">
        <div v-for="(entry, idx) in leaderboard" :key="entry.uid || idx"
             class="bg-white rounded-lg shadow-md p-4 flex items-center space-x-4 mb-3 leaderboard-tile">
          <div class="flex-shrink-0">
            <img :src="getBoatImage(entry)" :alt="entry.boat"
                 class="w-16 h-16 object-cover rounded-full border-2"
                 :class="getBorderClass(idx)">
          </div>
          <div class="flex-1">
            <h3 class="text-lg font-semibold">{{ idx+1 }}. {{ entry.boat || 'Unknown Boat' }}</h3>
            <p class="text-sm text-gray-600">{{ entry.points || 0 }} pts</p>
          </div>
        </div>
      </div>
      <div v-else-if="!loading" class="placeholder">No leaderboard data available.</div>
    </div>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          leaderboard: [],
          top3: [],
          tournament: localStorage.getItem('selectedTournament') || 'BigRock',
          tournamentLogo: '',
          boatImages: {},
          loading: true
        }
      },
      methods: {
        normalize(uidOrName) {
          return (uidOrName || '').toLowerCase().replace(/[^a-z0-9]/g, '_');
        },
        getBoatImage(entry) {
          const uid = this.normalize(entry.uid || entry.boat);
          return this.boatImages[uid] || `/static/images/boats/${uid}.webp`;
        },
        getBorderClass(idx) {
          if (idx === 0) return 'border-yellow-400';
          if (idx === 1) return 'border-gray-400';
          if (idx === 2) return 'border-orange-400';
          return 'border-gray-300';
        },
        async loadBoatImages() {
          try {
            const res = await fetch(`/participants/${this.tournament}`);
            const data = await res.json();
            const images = {};
            (data.participants || data || []).forEach(p => {
              const uid = this.normalize(p.uid || p.boat);
              images[uid] = p.image_path || `/static/images/boats/${uid}.webp`;
            });
            this.boatImages = images;
          } catch (e) {
            console.warn('Failed to load participant images', e);
          }
        }
      },
      async mounted() {
        // Load logo with fallback
        try {
          const settings = await fetch('https://js9467.github.io/Brtourney/settings.json').then(r => r.json());
          this.tournamentLogo = settings[this.tournament]?.logo || '/static/images/logo.png';
        } catch (e) {
          this.tournamentLogo = '/static/images/logo.png';
        }

        // Load boat images
        await this.loadBoatImages();

        // Load leaderboard
        try {
          const data = await fetch(`/leaderboard/${this.tournament}`).then(r => r.json());
          this.leaderboard = data.leaderboard || data || [];
          this.top3 = this.leaderboard.slice(0, 3);
        } catch (e) {
          console.error("Failed to load leaderboard:", e);
        } finally {
          this.loading = false;
        }
      }
    }).mount("#app");
  </script>
</body>
</html>