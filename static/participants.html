<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Participants</title>
    <link href="https://fonts.googleapis.com/css2?family=Lobster&family=Montserrat:wght@700&family=Roboto:wght@400;500" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
</head>
<body class="{{ theme_class }}">

<div id="app">
    <header>
        <img :src="logoSrc" alt="Tournament Logo">

        <h1>Participants</h1>
        <div class="control-buttons">
            <button class="settings-icon" @click="goBack">‚Üê Back</button>
        </div>
    </header>

    <div v-if="error" class="error">{{ error }}</div>

    <div class="participants-list">
        <div v-for="participant in participants" :key="participant.uid" class="participant-item">
            <img v-if="participant.image" :src="participant.image" alt="Boat Image" class="boat-image" @error="handleImageError">
            <span class="boat-name">{{ participant.boat }}</span>
            <button :class="{ followed: followedBoats.includes(participant.boat) }" @click="toggleFollow(participant.boat)">
                {{ followedBoats.includes(participant.boat) ? 'Unfollow' : 'Follow' }}
            </button>
        </div>
        <div v-if="participants.length === 0" class="no-participants">No participants available</div>
    </div>
</div>

<script>
    new Vue({
        el: '#app',
        data: {
            participants: [],
            followedBoats: [],
            settings: {
                tournament: 'Big Rock',
                logo_url: ''
            },
            error: null
        },
        computed: {
            logoSrc() {
                const t = this.settings.tournament;
                if (t === 'Edisto Invitational Billfish') {
                    return 'https://cdn.reeltimeapps.com/tournaments/logos/000/000/720/original/AppIconLight2025.png?1740721490';
                } else if (t === 'KWLA') {
                    return 'https://tournament.thebigrock.com/assets/kwla-logo.png';
                } else if (t === 'Kids') {
                    return 'https://tournament.thebigrock.com/assets/kids-logo.png';
                } else if (t === 'Big Rock') {
                    return '/static/images/WHITELOGOBR.png';
                } else {
                    return '/static/images/WHITELOGOBR.png'; // fallback
                }
            }
        },
        methods: {
            async loadParticipants() {
                try {
                    this.error = null;
                    const response = await fetch('/api/participants');
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    this.participants = await response.json() || [];
                } catch (e) {
                    this.error = 'Failed to load participants: ' + e.message;
                    this.participants = [];
                }
            },
            toggleFollow(name) {
                if (this.followedBoats.includes(name)) {
                    this.followedBoats = this.followedBoats.filter(b => b !== name);
                } else {
                    this.followedBoats.push(name);
                }
                this.saveSettings();
            },
            async saveSettings() {
                try {
                    await fetch('/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ followed_boats: this.followedBoats })
                    });
                } catch (e) {
                    console.error('Error saving settings:', e);
                }
            },
            async loadSettings() {
                try {
                    const response = await fetch('/settings');
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const settings = await response.json();
                    this.settings = { ...this.settings, ...settings };
                    this.followedBoats = settings.followed_boats || [];
                    this.applyTheme();
                } catch (e) {
                    console.error('Error loading settings:', e);
                }
            },
            handleImageError(event) {
                event.target.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAA6ElEQVR4nO3QwQ3AIBDAsNLJb3RWIC+EZE8QZc3Mx5n/dsBLzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCswKzArMCjbLZgJIjFtsAQAAAABJRU5ErkJggg==';
            },
            goBack() {
                window.location.href = '/';
            },
            applyTheme() {
                const tournamentClass = 'theme-' + this.settings.tournament.toLowerCase().replace(/\s+/g, '-');
                document.body.className = tournamentClass;
            }
        },
        mounted() {
            this.loadSettings();
            this.loadParticipants();
        }
    });
</script>
</body>
</html>
