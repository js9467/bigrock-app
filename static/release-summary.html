<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Release Summary</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="/static/css/base.css">
</head>
<body class="bg-gray-100 text-gray-900 font-sans">

<div id="app">
  <!-- Header -->
  <header class="bg-brand-blue text-white flex items-center justify-between px-4 py-3 shadow-md">
  <div class="flex items-center space-x-4">
    <img v-if="tournamentLogo" :src="tournamentLogo" alt="Tournament Logo" class="h-14 drop-shadow" />
    <span v-else class="text-white text-base">Loading Logo...</span>
  </div>
  <div class="flex items-center gap-3">
    <a href="/" class="px-4 py-2 text-white font-semibold border border-white rounded hover:bg-white hover:text-blue-900 transition">Back</a>
  </div>
</header>


  <!-- Demo Banner -->
  <div v-if="demoMode" class="bg-yellow-400 text-black font-semibold p-2 text-center">
    DEMO MODE — Data is simulated from a previous tournament
  </div>

  <!-- Summary Table -->
  <div class="p-6 max-w-5xl mx-auto w-full">
    <h1 class="text-2xl font-bold text-brand-blue mb-4">Release Summary</h1>
    <div v-if="loading" class="text-gray-500 italic">Loading release summary...</div>
    
    <div v-else>
      <table class="w-full border border-gray-300 bg-white rounded shadow-md overflow-hidden mb-8">
        <thead class="bg-brand-blue text-white">
          <tr>
            <th class="p-2">Date</th>
            <th class="p-2">Blue Marlin</th>
            <th class="p-2">White Marlin</th>
            <th class="p-2">Sailfish</th>
            <th class="p-2">Total Releases</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="day in summary" :key="day.date" class="border-b hover:bg-gray-50">
            <td class="p-2 font-semibold">{{ formatDate(day.date) }}</td>
            <td class="p-2 text-center">{{ day.blue_marlins }}</td>
            <td class="p-2 text-center">{{ day.white_marlins }}</td>
            <td class="p-2 text-center">{{ day.sailfish }}</td>
            <td class="p-2 text-center font-bold">{{ day.total_releases }}</td>
          </tr>
        </tbody>
      </table>

      <!-- Chart -->
      <div class="bg-white rounded shadow-md p-4">
        <h2 class="text-lg font-bold text-brand-blue mb-4">Daily Release Totals</h2>
        <canvas id="releaseChart" height="120"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      summary: [],
      loading: true,
      tournamentLogo: '',
      version: '',
      demoMode: false,
      chart: null
    };
  },
  mounted() {
    this.fetchSummary();
    this.fetchVersion();
    this.loadTournamentLogo();
  },
  methods: {
    fetchSummary() {
      fetch('/release-summary')
        .then(res => res.json())
        .then(data => {
          this.summary = data.summary || [];
          this.demoMode = data.demo_mode || false;
          this.loading = false;
          this.renderChart();
        })
        .catch(err => {
          console.error('❌ Failed to load release summary:', err);
          this.loading = false;
        });
    },
    fetchVersion() {
      fetch('/api/version')
        .then(res => res.json())
        .then(data => {
          this.version = data.version;
        });
    },
    loadTournamentLogo() {
      fetch('/api/settings')
        .then(res => res.json())
        .then(settings => {
          const tournament = settings.tournament;
          return fetch('https://js9467.github.io/Brtourney/settings.json')
            .then(res => res.json())
            .then(all => {
              this.tournamentLogo = all[tournament]?.logo || '';
            });
        });
    },
    formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    },
    renderChart() {
      if (!this.summary.length) return;
      const ctx = document.getElementById('releaseChart').getContext('2d');

      // Destroy old chart if exists
      if (this.chart) {
        this.chart.destroy();
      }

      const labels = this.summary.map(day => this.formatDate(day.date)).reverse();
      const totals = this.summary.map(day => day.total_releases).reverse();
      const blue = this.summary.map(day => day.blue_marlins).reverse();
      const white = this.summary.map(day => day.white_marlins).reverse();
      const sail = this.summary.map(day => day.sailfish).reverse();

      this.chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            { label: 'Blue Marlin', data: blue, backgroundColor: '#3b82f6' },
            { label: 'White Marlin', data: white, backgroundColor: '#a78bfa' },
            { label: 'Sailfish', data: sail, backgroundColor: '#22c55e' }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            x: { stacked: true },
            y: { stacked: true, beginAtZero: true }
          }
        }
      });
    }
  }
}).mount('#app');
</script>

</body>
</html>
