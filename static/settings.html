<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- If you already have base.css, keep it; otherwise basic styles here are fine -->
  <link rel="stylesheet" href="/static/css/base.css" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .container { max-width: 900px; margin: 2rem auto; padding: 1rem; }
    .card { background: #fff; border: 1px solid #ddd; border-radius: 12px; padding: 1rem 1.25rem; margin-bottom: 1rem; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; }
    label { font-weight: 600; margin-bottom: .25rem; display: block; }
    select, input[type="text"], input[type="email"], textarea {
      width: 100%; padding: .6rem .7rem; border-radius: 8px; border: 1px solid #9ca3af; background: #fff; color: #111827;
    }
    button { padding: .55rem .9rem; border-radius: 10px; border: 1px solid #374151; background: #111827; color: #fff; cursor: pointer; }
    button.secondary { background: #fff; color: #111827; border: 1px solid #9ca3af; }
    button:disabled { opacity: .55; cursor: not-allowed; }
    .muted { color: #6b7280; font-size: .9rem; }
    .pill { display: inline-flex; align-items: center; gap: .4rem; padding: .25rem .55rem; border-radius: 999px; border: 1px solid #d1d5db; margin: .25rem .25rem .25rem 0; }
    .pill button { border: 0; background: transparent; color: #ef4444; padding: 0 .2rem; }
    .flex { display: flex; gap: .5rem; align-items: center; }
    .between { display: flex; justify-content: space-between; align-items: center; gap: 1rem; }
    .mb-1 { margin-bottom: .25rem; } .mb-2 { margin-bottom: .5rem; } .mb-3 { margin-bottom: .75rem; } .mb-4 { margin-bottom: 1rem; }
    .mt-2 { margin-top: .5rem; } .mt-3 { margin-top: .75rem; } .mt-4 { margin-top: 1rem; }
    .tag { font-size: .85rem; color: #374151; }
    .danger { color: #b91c1c; }
    .success { color: #065f46; }
  </style>
</head>
<body>
  <div id="app" class="container">
    <h1 class="mb-3">Settings</h1>

    <!-- Mode & Tournament -->
    <div class="card">
      <div class="row">
        <div>
          <label class="mb-1">Data Source</label>
          <select v-model="settings.data_source">
            <option value="live">Live</option>
            <option value="demo">Demo</option>
          </select>
          <div class="muted mt-2">“Live” scrapes real pages. “Demo” uses injected events based on cached data.</div>
        </div>

        <div>
          <label class="mb-1">Tournament</label>
          <div v-if="hasTournaments">
            <select v-model="settings.tournament">
              <option disabled value="">-- Select Tournament --</option>
              <option v-for="(info, name) in validTournaments"
                      :key="name"
                      :value="name">
                {{ name }}{{ info && info.label ? ' (' + info.label + ')' : '' }}
              </option>
            </select>
            <div class="flex mt-2">
              <button class="secondary" @click="refreshTournamentDates" :disabled="busy">
                {{ busy ? 'Refreshing…' : 'Refresh Tourney Dates' }}
              </button>
              <span class="muted">If dates look stale, refresh to rescrape labels</span>
            </div>
          </div>
          <div v-else class="muted">Loading tournaments…</div>
        </div>
      </div>
    </div>

    <!-- Sounds -->
    <div class="card">
      <div class="row">
        <div>
          <label class="mb-1">Followed Boat Sound</label>
          <select v-model="settings.followed_sound">
            <option v-for="s in soundFiles" :key="s" :value="s.replace('.mp3','')">
              {{ s.replace('.mp3','') }}
            </option>
          </select>
        </div>
        <div>
          <label class="mb-1">Boated Sound</label>
          <select v-model="settings.boated_sound">
            <option v-for="s in soundFiles" :key="s" :value="s.replace('.mp3','')">
              {{ s.replace('.mp3','') }}
            </option>
          </select>
        </div>
      </div>
      <div class="muted mt-2">Sounds are read from <code>/static/sounds</code>.</div>
    </div>

    <!-- Alerts / SMS emails -->
    <div class="card">
      <div class="between">
        <div>
          <label class="mb-1">Alert Recipients (Email or SMS Gateway)</label>
          <div class="muted">Add recipients who should receive boat alerts.</div>
        </div>
        <div>
          <button class="secondary" @click="sendTestAlert" :disabled="busy">Send Test Alert</button>
        </div>
      </div>

      <div class="mt-3">
        <div class="flex">
          <input type="email" v-model.trim="newRecipient" placeholder="user@example.com or 9195551212@vtext.com" />
          <button @click="addRecipient" :disabled="!newRecipient">Add</button>
        </div>

        <div class="mt-2">
          <span v-if="recipients.length === 0" class="muted">No recipients yet.</span>
          <span v-for="(r, idx) in recipients" :key="r+idx" class="pill">
            <span class="tag">{{ r }}</span>
            <button title="Remove" @click="removeRecipient(idx)">×</button>
          </span>
        </div>
      </div>
    </div>

    <!-- Save -->
    <div class="between mt-3">
      <div>
        <span v-if="saveState==='saved'" class="success">Saved!</span>
        <span v-else-if="saveState==='error'" class="danger">Save failed.</span>
        <span v-else class="muted">Changes are saved to <code>settings.json</code>.</span>
      </div>
      <div class="flex">
        <button class="secondary" @click="reloadSettings" :disabled="busy">Revert</button>
        <button @click="save" :disabled="busy">Save</button>
      </div>
    </div>
  </div>

  <!-- Vue 3.4.15 (matches your version) -->
  <script src="https://unpkg.com/vue@3.4.15/dist/vue.global.prod.js"></script>
  <script>
  (function () {
    const App = {
      data() {
        return {
          busy: false,
          saveState: '', // '', 'saved', 'error'
          settings: {
            data_source: 'live',
            tournament: '',
            followed_sound: 'Fishing Reel',
            boated_sound: 'Fishing Reel',
            sms_emails: [] // mirrored from alerts.json via /api/settings GET
          },
          validTournaments: {}, // { Name: {start, end, label}, ... }
          soundFiles: [],
          recipients: [],
          newRecipient: ''
        };
      },
      computed: {
        hasTournaments() {
          return this.validTournaments && Object.keys(this.validTournaments).length > 0;
        }
      },
      async created() {
        await this.bootstrap();
      },
      methods: {
        async bootstrap() {
          try {
            this.busy = true;
            // Load settings, tournaments, and available sounds
            const [sRes, tRes, sndRes] = await Promise.all([
              fetch('/api/settings'),
              fetch('/api/tournaments'),
              fetch('/sounds')
            ]);

            const sJson = await sRes.json();
            const tJson = await tRes.json();
            const sndJson = await sndRes.json();

            // Settings
            this.settings = Object.assign({
              data_source: 'live',
              tournament: '',
              followed_sound: 'Fishing Reel',
              boated_sound: 'Fishing Reel',
              sms_emails: []
            }, sJson || {});
            // Alerts list (comes from /api/settings GET merged in server)
            this.recipients = Array.isArray(this.settings.sms_emails) ? this.settings.sms_emails.slice() : [];

            // Tournaments
            this.validTournaments = (tJson && tJson.tournaments) ? tJson.tournaments : {};
            // If no tournament set yet, pick the first
            if (!this.settings.tournament) {
              const first = Object.keys(this.validTournaments)[0];
              if (first) this.settings.tournament = first;
            }

            // Sounds
            this.soundFiles = Array.isArray(sndJson.files) ? sndJson.files : [];

            this.saveState = '';
          } catch (e) {
            console.error('Bootstrap failed:', e);
            this.saveState = 'error';
          } finally {
            this.busy = false;
          }
        },

        async refreshTournamentDates() {
          try {
            this.busy = true;
            await fetch('/scrape/tournament_dates', { method: 'POST' });
            // Reload tournaments
            const tRes = await fetch('/api/tournaments');
            const tJson = await tRes.json();
            this.validTournaments = (tJson && tJson.tournaments) ? tJson.tournaments : {};
          } catch (e) {
            console.error('Refresh tournament dates failed:', e);
          } finally {
            this.busy = false;
          }
        },

        addRecipient() {
          const email = (this.newRecipient || '').trim();
          if (!email) return;
          if (!this.recipients.includes(email)) {
            this.recipients.push(email);
          }
          this.newRecipient = '';
        },

        removeRecipient(idx) {
          this.recipients.splice(idx, 1);
        },

        async sendTestAlert() {
          try {
            this.busy = true;
            const res = await fetch('/alerts/test');
            const js = await res.json();
            if (js.status === 'sent') {
              this.saveState = 'saved';
            } else {
              this.saveState = 'error';
            }
          } catch (e) {
            console.error('Test alert failed:', e);
            this.saveState = 'error';
          } finally {
            this.busy = false;
            setTimeout(() => (this.saveState = ''), 2000);
          }
        },

        async reloadSettings() {
          await this.bootstrap();
        },

        async save() {
          try {
            this.busy = true;
            // mirror recipients into settings.sms_emails
            this.settings.sms_emails = this.recipients.slice();

            const res = await fetch('/api/settings', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(this.settings)
            });
            const js = await res.json();
            if (js.status === 'success') {
              this.saveState = 'saved';
              // Optionally re-bootstrap to pull any server-side adjustments
              // await this.bootstrap();
            } else {
              this.saveState = 'error';
            }
          } catch (e) {
            console.error('Save failed:', e);
            this.saveState = 'error';
          } finally {
            this.busy = false;
            setTimeout(() => (this.saveState = ''), 2000);
          }
        }
      }
    };

    // mount & expose for console debugging
    window.__app = Vue.createApp(App).mount('#app');
  })();
  </script>
</body>
</html>
