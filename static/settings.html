<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Settings</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3.4.15/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.8/dist/axios.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/css/base.css">
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
  <div id="app" class="p-6 max-w-2xl mx-auto space-y-8">
    <h1 class="text-3xl font-bold mb-4">âš™ï¸ Settings</h1>

    <div>
      <label class="block font-semibold mb-1">Sound for Followed Boat Activity</label>
      <select v-model="settings.followed_sound" @change="previewSound(settings.followed_sound); saveSettings()" class="w-full p-2 rounded border border-gray-400 bg-white text-black">
        <option disabled value="">-- Select Sound --</option>
        <option v-for="file in availableSounds" :key="file" :value="file">{{ file }}</option>
      </select>
    </div>

    <div>
      <label class="block font-semibold mb-1">Sound for Boated Events</label>
      <select v-model="settings.boated_sound" @change="previewSound(settings.boated_sound); saveSettings()" class="w-full p-2 rounded border border-gray-400 bg-white text-black">
        <option disabled value="">-- Select Sound --</option>
        <option v-for="file in availableSounds" :key="file" :value="file">{{ file }}</option>
      </select>
    </div>

    <div>
      <label class="block font-semibold mb-1">Event Volume</label>
      <input type="range" min="0" max="100" v-model="settings.event_volume" @change="saveSettings" class="w-full">
      <span>{{ settings.event_volume }}%</span>
    </div>

    <div>
      <label class="block font-semibold mb-1">Radio Volume</label>
      <input type="range" min="0" max="100" v-model="settings.radio_volume" @change="saveSettings" class="w-full">
      <span>{{ settings.radio_volume }}%</span>
    </div>
  </div>

  <script>
    const { createApp } = Vue

    createApp({
      data() {
        return {
          settings: {
            followed_sound: '',
            boated_sound: '',
            event_volume: 80,
            radio_volume: 30,
            sounds_enabled: true,
            data_source: 'live',
            tournament: ''
          },
          availableSounds: []
        }
      },
      mounted() {
        this.loadSettings()
        this.loadAvailableSounds()
      },
      methods: {
        loadSettings() {
          fetch('/api/settings')
            .then(res => res.json())
            .then(data => {
              this.settings = { ...this.settings, ...data }
            })
        },
        saveSettings() {
          localStorage.setItem('settings', JSON.stringify(this.settings))
          fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(this.settings)
          })
        },
        loadAvailableSounds() {
          fetch('/static/sounds/')
            .then(res => res.text())
            .then(html => {
              const matches = html.match(/href="(.*?)\.mp3"/g) || []
              this.availableSounds = matches.map(m => m.split('"')[1].replace('.mp3', ''))
            })
        },
        previewSound(name) {
          if (!name) return
          const audio = new Audio(`/static/sounds/${name}.mp3`)
          audio.volume = this.settings.event_volume / 100
          audio.play().catch(e => console.warn("ğŸ”‡ Preview failed:", e))
        }
      }
    }).mount('#app')
  </script>
</body>
</html>
