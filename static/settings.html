<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@3.4.15/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.8/dist/axios.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/css/base.css" />
  <style>
    .toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1000;
    }
    .toast-item {
      margin-top: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 0.375rem;
      font-weight: 500;
      animation: fadein 0.3s ease;
    }
    @keyframes fadein {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans overflow-y-auto">
  <div id="app" class="min-h-screen flex flex-col">
    <!-- Toasts -->
    <div class="toast">
      <div
        v-for="(toast, index) in toasts"
        :key="index"
        :class="[
          'toast-item text-white shadow-md',
          toast.type === 'success' ? 'bg-green-600' :
          toast.type === 'error' ? 'bg-red-600' : 'bg-yellow-500'
        ]"
      >
        {{ toast.message }}
      </div>
    </div>

    <!-- Header -->
    <header class="bg-brand-blue text-white flex items-center justify-between px-4 py-3 shadow-md">
      <div class="flex items-center space-x-4">
        <img v-if="tournamentLogo" :src="tournamentLogo" alt="Tournament Logo" class="h-14 drop-shadow" />
        <span v-else class="text-white text-base">Loading Logo...</span>
      </div>
      <a href="/" class="px-4 py-2 text-white font-semibold border border-white rounded hover:bg-white hover:text-blue-900 transition">‚Üê Back</a>
    </header>

    <main class="flex-grow p-6 w-full max-w-screen-xl mx-auto bg-white shadow-xl rounded-xl mt-6 space-y-8">
      <h1 class="text-3xl font-bold text-brand-gold mb-2">‚öôÔ∏è Settings</h1>

      <!-- Tournament -->
      <div>
        <label class="block font-semibold mb-1">Tournament</label>
        <select v-model="settings.tournament" class="w-full p-2 rounded border border-gray-400 bg-white text-black focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option disabled value="">-- Select Tournament --</option>
          <option v-for="(value, name) in validTournaments" :key="name" :value="name">{{ name }}</option>
        </select>
      </div>

      <!-- Data Source -->
      <div class="flex items-center space-x-4">
        <span class="font-semibold">Data Source:</span>
        <label class="inline-flex items-center"><input type="radio" value="live" v-model="settings.data_source" class="mr-1"> Live</label>
        <label class="inline-flex items-center"><input type="radio" value="demo" v-model="settings.data_source" class="mr-1"> Demo</label>
      </div>

      <!-- Volume Controls -->
      <div>
        <label class="block font-semibold mb-1">Event Volume</label>
        <input type="range" min="0" max="100" v-model="settings.event_volume" class="w-full" />
        <div class="text-center">{{ settings.event_volume }}%</div>
      </div>

      <!-- Sound Options -->
      <div class="flex items-center space-x-3">
        <div class="w-full">
          <label class="block font-semibold mb-1">Followed Boat Activity</label>
          <select v-model="settings.hooked_sound" class="w-full p-2 rounded border border-gray-400 bg-white" @change="autoPlaySound(settings.hooked_sound)">
            <option disabled value="">-- Select Sound --</option>
            <option v-for="sound in soundLibrary" :key="sound" :value="sound">
              {{ sound.replace('.mp3', '') }}
            </option>
          </select>
        </div>
      </div>

      <div class="flex items-center space-x-3">
        <div class="w-full">
          <label class="block font-semibold mb-1">Hooked Up (Any Boat)</label>
          <select v-model="settings.boated_sound" class="w-full p-2 rounded border border-gray-400 bg-white" @change="autoPlaySound(settings.boated_sound)">
            <option disabled value="">-- Select Sound --</option>
            <option v-for="sound in soundLibrary" :key="sound" :value="sound">
              {{ sound.replace('.mp3', '') }}
            </option>
          </select>
        </div>
      </div>

      <div class="flex items-center space-x-2">
        <input type="checkbox" id="sounds" v-model="settings.sounds_enabled" />
        <label for="sounds" class="font-semibold">Play Event Sounds</label>
      </div>
    </main>

    <!-- Vue App -->
    <script>
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            settings: {
              tournament: '',
              data_source: 'live',
              refresh_interval: 30,
              event_volume: 80,
              vhf_volume: 70,
              sounds_enabled: true,
              hooked_sound: '',
              boated_sound: ''
            },
            tournaments: {},
            tournamentLogo: '',
            soundLibrary: [],
            toasts: []
          };
        },
        computed: {
          validTournaments() {
            return Object.fromEntries(Object.entries(this.tournaments).filter(([_, val]) => val));
          }
        },
        methods: {
          showToast(message, type = 'info') {
            const toast = { message, type };
            this.toasts.push(toast);
            setTimeout(() => {
              const index = this.toasts.indexOf(toast);
              if (index !== -1) this.toasts.splice(index, 1);
            }, 3000);
          },
          playSound(file) {
            if (!file) return;
            const audio = new Audio(`/static/sounds/${file}`);
            audio.volume = this.settings.event_volume / 100;
            audio.play().catch(err => console.warn("Sound error:", err));
          },
          autoPlaySound(file) {
            this.playSound(file);
            this.showToast(`üîä Playing: ${file.replace('.mp3', '')}`, 'info');
          },
          updateLogo() {
            const t = this.settings.tournament;
            if (this.tournaments[t]) {
              this.tournamentLogo = this.tournaments[t].logo;
            }
          }
        },
        mounted() {
          axios.get('/api/settings').then(res => {
            this.settings = { ...this.settings, ...res.data };
            this.updateLogo();
          });
          axios.get('https://js9467.github.io/Brtourney/settings.json').then(res => {
            this.tournaments = res.data;
            this.updateLogo();
          });
          axios.get('/sounds').then(res => {
            this.soundLibrary = res.data.files;
          });
        },
        watch: {
          settings: {
            handler(newSettings) {
              axios.post('/api/settings', newSettings)
                .then(() => this.showToast('‚úÖ Settings saved', 'success'))
                .catch(err => this.showToast('‚ùå Failed to save settings', 'error'));
            },
            deep: true
          },
          'settings.tournament'(newVal) {
            this.updateLogo();
          }
        }
      }).mount('#app');
    </script>
</body>
</html>
