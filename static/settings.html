<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Settings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3.4.15/dist/vue.global.prod.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/css/base.css" />
  <style>
    .card { @apply bg-white border border-gray-200 rounded-2xl shadow-sm; }
    .btn { @apply inline-flex items-center justify-center font-semibold rounded-xl px-4 py-2 transition; }
    .btn-primary { @apply bg-yellow-400 text-blue-900 hover:bg-yellow-300 border border-yellow-500; }
    .btn-ghost { @apply bg-white text-gray-900 border border-gray-300 hover:bg-gray-50; }
    .btn-dark { @apply bg-blue-950 text-white border border-yellow-400 hover:bg-blue-900; }
    .chip { @apply inline-flex items-center gap-2 px-3 py-1 rounded-full border border-yellow-400 bg-yellow-100 text-yellow-900; }
    .muted { @apply text-gray-500; }
    .section-title { @apply text-lg font-bold text-white; }
    .card-title { @apply text-base font-semibold text-gray-900 mb-2; }
    .field-label { @apply block font-semibold mb-1 text-gray-800; }
    .field { @apply w-full p-2.5 rounded-xl border border-gray-300 bg-white text-gray-900; }
    .toolbar { @apply flex items-center justify-between gap-3; }
    .grid-2 { @apply grid grid-cols-1 md:grid-cols-2 gap-4; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen">
  <!-- Header bar -->
  <header class="bg-brand-blue text-white px-4 py-4 shadow-lg">
    <div class="max-w-6xl mx-auto flex flex-col md:flex-row items-start md:items-center gap-3 md:gap-6">
      <div class="flex items-center gap-3">
        <a href="/" class="btn btn-primary !py-1.5 !px-3 shadow-md">← Back</a>
        <h1 class="section-title">Settings</h1>
      </div>
      <div class="flex-1"></div>
      <div class="flex items-center gap-2">
        <div class="chip" v-if="headerTournament">
          <span class="font-semibold">{{ headerTournament }}</span>
          <span v-if="headerLabel" class="opacity-80">• {{ headerLabel }}</span>
        </div>
        <span v-else class="text-white/70">Loading tournament…</span>
      </div>
    </div>
  </header>

  <main id="app" class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- Data Source & Tournament -->
    <section class="card p-5">
      <div class="toolbar mb-4">
        <h2 class="card-title m-0">Tournament & Data Source</h2>
        <div class="flex items-center gap-2">
          <button class="btn btn-ghost" @click="refreshTournamentDates" :disabled="busy">
            {{ busy ? 'Refreshing…' : 'Refresh Tourney Dates' }}
          </button>
        </div>
      </div>

      <div class="grid-2">
        <div>
          <label class="field-label">Data Source</label>
          <select v-model="settings.data_source" class="field">
            <option value="live">Live</option>
            <option value="demo">Demo</option>
          </select>
          <p class="muted mt-2">
            <span class="font-semibold">Live</span> scrapes real pages.
            <span class="font-semibold">Demo</span> injects “Hooked Up” events from cached results.
          </p>
        </div>

        <div>
          <label class="field-label">Tournament</label>
          <div v-if="hasTournaments">
            <select v-model="settings.tournament" class="field">
              <option disabled value="">— Select Tournament —</option>
              <option v-for="(info, name) in validTournaments"
                      :key="name"
                      :value="name">
                {{ name }}{{ info && info.label ? ' (' + info.label + ')' : '' }}
              </option>
            </select>
            <p class="muted mt-2">
              These dates are scraped and cached. Use “Refresh Tourney Dates” if they look stale.
            </p>
          </div>
          <div v-else class="muted">Loading tournaments…</div>
        </div>
      </div>
    </section>

    <!-- Sounds -->
    <section class="card p-5">
      <h2 class="card-title">Alert Sounds</h2>
      <div class="grid-2">
        <div>
          <label class="field-label">Followed Boat Sound</label>
          <select v-model="settings.followed_sound" class="field">
            <option v-for="s in soundFiles" :key="s" :value="s.replace('.mp3','')">
              {{ s.replace('.mp3','') }}
            </option>
          </select>
        </div>
        <div>
          <label class="field-label">Boated Sound</label>
          <select v-model="settings.boated_sound" class="field">
            <option v-for="s in soundFiles" :key="s" :value="s.replace('.mp3','')">
              {{ s.replace('.mp3','') }}
            </option>
          </select>
        </div>
      </div>
      <p class="muted mt-2">Files are read from <code>/static/sounds</code>. Volume is controlled on the main page.</p>
    </section>

    <!-- Alerts -->
    <section class="card p-5">
      <div class="toolbar mb-2">
        <h2 class="card-title m-0">Alert Recipients</h2>
        <button class="btn btn-dark" @click="sendTestAlert" :disabled="busy">Send Test Alert</button>
      </div>
      <p class="muted">Add email addresses or SMS gateways (e.g. <code>5551234567@vtext.com</code>).</p>

      <div class="flex items-center gap-2 mt-3">
        <input type="email" v-model.trim="newRecipient" placeholder="user@example.com"
               class="field flex-1" />
        <button class="btn btn-primary" @click="addRecipient" :disabled="!newRecipient">Add</button>
      </div>

      <div class="mt-3">
        <span v-if="recipients.length === 0" class="muted">No recipients added yet.</span>
        <div class="flex flex-wrap gap-2" v-else>
          <span v-for="(r, idx) in recipients" :key="r+idx"
                class="inline-flex items-center gap-2 px-3 py-1 rounded-full border border-gray-300 bg-gray-50">
            <span class="text-gray-800">{{ r }}</span>
            <button class="text-red-600 hover:text-red-800 font-bold" title="Remove"
                    @click="removeRecipient(idx)">×</button>
          </span>
        </div>
      </div>
    </section>

    <!-- Save / Revert -->
    <section class="flex items-center justify-between">
      <div>
        <span v-if="saveState==='saved'" class="text-emerald-700 font-semibold">Saved!</span>
        <span v-else-if="saveState==='error'" class="text-red-700 font-semibold">Save failed.</span>
        <span v-else class="muted">Changes are persisted to <code>settings.json</code>.</span>
      </div>
      <div class="flex items-center gap-2">
        <button class="btn btn-ghost" @click="reloadSettings" :disabled="busy">Revert</button>
        <button class="btn btn-primary" @click="save" :disabled="busy">Save</button>
      </div>
    </section>
  </main>

  <script>
  const { createApp } = Vue;

  createApp({
    data() {
      return {
        busy: false,
        saveState: '', // '', 'saved', 'error'
        settings: {
          data_source: 'live',
          tournament: '',
          followed_sound: 'Fishing Reel',
          boated_sound: 'Fishing Reel',
          sms_emails: []
        },
        validTournaments: {},       // { Name: {start, end, label}, ... }
        soundFiles: [],            // from /sounds
        recipients: [], newRecipient: '',
        headerTournament: '', headerLabel: ''
      };
    },
    computed: {
      hasTournaments() { return this.validTournaments && Object.keys(this.validTournaments).length > 0; }
    },
    async mounted() {
      await this.bootstrap();
      await this.loadHeaderMeta();
    },
    methods: {
      async bootstrap() {
        try {
          this.busy = true;
          const [sRes, tRes, sndRes] = await Promise.all([
            fetch('/api/settings'),
            fetch('/api/tournaments'),
            fetch('/sounds')
          ]);
          const s = await sRes.json();
          const t = await tRes.json();
          const snd = await sndRes.json();

          // settings
          this.settings = Object.assign({
            data_source: 'live',
            tournament: '',
            followed_sound: 'Fishing Reel',
            boated_sound: 'Fishing Reel',
            sms_emails: []
          }, s || {});
          this.recipients = Array.isArray(this.settings.sms_emails) ? this.settings.sms_emails.slice() : [];

          // tournaments
          this.validTournaments = (t && t.tournaments) ? t.tournaments : {};
          if (!this.settings.tournament) {
            const first = Object.keys(this.validTournaments)[0];
            if (first) this.settings.tournament = first;
          }

          // sounds
          this.soundFiles = Array.isArray(snd.files) ? snd.files : [];

          this.saveState = '';
        } catch (e) {
          console.error('Bootstrap failed:', e);
          this.saveState = 'error';
        } finally {
          this.busy = false;
        }
      },

      async loadHeaderMeta() {
        try {
          const [sRes, tRes] = await Promise.all([
            fetch('/api/settings'), fetch('/api/tournaments')
          ]);
          const s = await sRes.json();
          const t = await tRes.json();
          const name = (s && s.tournament) || '';
          const info = (t && t.tournaments) ? t.tournaments[name] : null;
          this.headerTournament = name || '';
          this.headerLabel = (info && info.label) ? info.label : '';
        } catch (e) {
          console.warn('Header meta failed:', e);
        }
      },

      async refreshTournamentDates() {
        try {
          this.busy = true;
          await fetch('/scrape/tournament_dates', { method: 'POST' });
          const tRes = await fetch('/api/tournaments');
          const t = await tRes.json();
          this.validTournaments = (t && t.tournaments) ? t.tournaments : {};
          await this.loadHeaderMeta();
        } catch (e) {
          console.error('Refresh tournament dates failed:', e);
        } finally {
          this.busy = false;
        }
      },

      addRecipient() {
        const email = (this.newRecipient || '').trim();
        if (!email) return;
        if (!this.recipients.includes(email)) this.recipients.push(email);
        this.newRecipient = '';
      },
      removeRecipient(idx) { this.recipients.splice(idx, 1); },

      async sendTestAlert() {
        try {
          this.busy = true;
          const res = await fetch('/alerts/test');
          const js = await res.json();
          this.saveState = (js.status === 'sent') ? 'saved' : 'error';
        } catch (e) {
          console.error('Test alert failed:', e);
          this.saveState = 'error';
        } finally {
          this.busy = false;
          setTimeout(() => (this.saveState = ''), 2000);
        }
      },

      async reloadSettings() { await this.bootstrap(); await this.loadHeaderMeta(); },

      async save() {
        try {
          this.busy = true;
          this.settings.sms_emails = this.recipients.slice();
          const res = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(this.settings)
          });
          const js = await res.json();
          this.saveState = (js.status === 'success') ? 'saved' : 'error';
        } catch (e) {
          console.error('Save failed:', e);
          this.saveState = 'error';
        } finally {
          this.busy = false;
          setTimeout(() => (this.saveState = ''), 2000);
        }
      }
    }
  }).mount('main');
  </script>
</body>
</html>
