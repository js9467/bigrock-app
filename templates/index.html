<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Events Feed</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <link rel="stylesheet" href="/static/css/base.css" />
  <style>
    body { touch-action: manipulation; }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #f6c553;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .toast {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background-color: #dc2626;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      z-index: 9999;
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
  <div id="app">
    <!-- Header -->
    <header class="bg-brand-blue text-white flex items-center justify-between px-4 py-3 shadow-md">
      <div class="flex items-center space-x-4">
        <img v-if="tournamentLogo" :src="tournamentLogo" alt="Tournament Logo" class="h-14 drop-shadow">
        <span v-else class="text-white text-base">Loading Logo...</span>
      </div>
      <div class="flex items-center space-x-4">
        <button @click="toggleRadio" class="bg-white text-brand-blue font-bold px-3 py-1 rounded hover:bg-gray-200">
          {{ radioPlaying ? 'ðŸ”‡ Stop VHF' : 'ðŸ”Š VHF' }}
        </button>
        <a href="/leaderboard" class="bg-white text-brand-blue font-bold px-3 py-1 rounded hover:bg-gray-200">Leaderboard</a>
      </div>
    </header>

    <!-- Toast error -->
    <div v-if="error" class="toast">{{ error }}</div>

    <!-- Hidden audio player -->
    <audio id="radio-player" hidden></audio>

    <!-- Main Content -->
    <main class="p-4">
      <div v-if="loading" class="text-center mt-10">
        <div class="spinner mx-auto mb-2"></div>
        <p>Loading events...</p>
      </div>

      <div v-else>
        <!-- Replace this with your event list rendering -->
        <p class="text-center text-gray-500">Events feed will render here...</p>
      </div>
    </main>
  </div>

  <script>
    const { createApp } = Vue;

    createApp({
      data() {
        return {
          radioPlaying: false,
          hls: null,
          error: null,
          tournamentLogo: null,
          settings: {},
          loading: true
        };
      },
      mounted() {
        fetch('/settings')
          .then(res => res.json())
          .then(data => {
            this.settings = data;
            if (data.tournament && data.tournament.logo) {
              this.tournamentLogo = data.tournament.logo;
            }
            this.radioPlaying = localStorage.getItem('radioPlaying') === 'true';
          });

        // Load events (replace with your real logic)
        setTimeout(() => {
          this.loading = false;
        }, 1000);
      },
      methods: {
        toggleRadio() {
          const player = document.getElementById('radio-player');
          const primaryStream = 'https://cs.ebmcdn.net/eastbay-live-hs-1/event/mp4:bigrockradio/playlist.m3u8';
          const fallbackStream = 'https://playertest.longtailvideo.com/adaptive/bbbfull/bbbfull.m3u8';

          const fallbackMessageBase = 'ðŸŽ£ Tournament VHF currently unavailable. Using test stream.';
          const isDemo = this.settings.data_source === 'demo';
          const fallbackMessage = isDemo ? `${fallbackMessageBase} You are in demo mode.` : fallbackMessageBase;

          const playStream = (url, isFallback = false) => {
            if (Hls.isSupported()) {
              this.hls = new Hls();
              this.hls.loadSource(url);
              this.hls.attachMedia(player);

              this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                player.volume = this.settings.radio_volume || 0.3;
                player.play()
                  .then(() => {
                    this.radioPlaying = true;
                    this.error = isFallback ? fallbackMessage : null;
                    localStorage.setItem('radioPlaying', 'true');
                  })
                  .catch(err => {
                    console.error('ðŸ”Š Audio play failed:', err);
                    if (!isFallback) {
                      this.hls.destroy();
                      this.hls = null;
                      playStream(fallbackStream, true);
                    } else {
                      this.error = fallbackMessage;
                      this.radioPlaying = false;
                    }
                  });
              });

              this.hls.on(Hls.Events.ERROR, (event, data) => {
                if (data.fatal) {
                  console.warn('ðŸ’¥ HLS fatal error:', data);
                  this.hls.destroy();
                  this.hls = null;
                  if (!isFallback) {
                    playStream(fallbackStream, true);
                  } else {
                    this.error = fallbackMessage;
                    this.radioPlaying = false;
                  }
                }
              });
            } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
              player.src = url;
              player.volume = this.settings.radio_volume || 0.3;
              player.play()
                .then(() => {
                  this.radioPlaying = true;
                  this.error = isFallback ? fallbackMessage : null;
                  localStorage.setItem('radioPlaying', 'true');
                })
                .catch(err => {
                  console.error('ðŸ”Š Native HLS play failed:', err);
                  if (!isFallback) {
                    playStream(fallbackStream, true);
                  } else {
                    this.error = fallbackMessage;
                    this.radioPlaying = false;
                  }
                });
            } else {
              this.error = fallbackMessage;
              this.radioPlaying = false;
            }
          };

          if (this.radioPlaying) {
            if (this.hls) {
              this.hls.destroy();
              this.hls = null;
            }
            player.pause();
            player.src = '';
            this.radioPlaying = false;
            this.error = null;
            localStorage.setItem('radioPlaying', 'false');
          } else {
            playStream(primaryStream, false);
          }
        }
      }
    }).mount('#app');
  </script>
</body>
</html>