<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Events Feed</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/css/base.css" />
  <style>
    body { touch-action: manipulation; }
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #f6c553;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
<div id="app">
  <!-- Header -->
  <header class="bg-blue-900 text-white flex items-center justify-between px-6 py-3 shadow-md">
    <div class="flex items-center space-x-4">
      <img v-if="tournamentLogo" :src="tournamentLogo" alt="Tournament Logo" class="h-14 drop-shadow">
      <span v-else class="text-white text-base">Loading Logo...</span>
    </div>
    <a href="/settings" class="text-sm text-white border border-white px-3 py-1 rounded hover:bg-blue-800">Settings</a>
  </header>

  <!-- Main Section -->
  <div v-if="!ready" class="flex items-center justify-center h-[80vh]">
    <div class="spinner"></div>
    <span class="ml-4 text-gray-600">Fetching event data...</span>
  </div>

  <div v-else class="grid grid-cols-3 gap-4 p-4">
    <!-- Hooked Up Section -->
    <div class="col-span-1">
      <h2 class="text-xl font-semibold mb-2">Hooked Up</h2>
      <div class="space-y-3">
        <div v-for="event in hooked" :key="event.timestamp + event.uid" class="bg-yellow-100 p-3 rounded shadow flex items-center space-x-3">
          <img :src="getBoatImage(event.uid)" class="w-20 h-20 object-cover rounded border" />
          <div>
            <div class="font-bold text-lg">{{ event.boat }}</div>
            <div class="text-sm text-gray-700">{{ formatTime(event.timestamp) }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Events Section -->
    <div class="col-span-2">
      <h2 class="text-xl font-semibold mb-2">Recent Events</h2>
      <div :key="feedKey" class="space-y-3">
        <div v-for="event in events" :key="event.timestamp + event.uid" class="bg-white p-3 rounded shadow flex items-center space-x-3">
          <img :src="getBoatImage(event.uid)" class="w-20 h-20 object-cover rounded border" />
          <div>
            <div class="font-bold text-lg">{{ event.boat }}</div>
            <div class="text-sm text-gray-600">{{ formatTime(event.timestamp) }} - {{ event.event }}</div>
            <div class="text-sm text-gray-700">{{ event.details }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Vue Script -->
<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      events: [],
      hooked: [],
      boatImages: {},
      tournamentLogo: null,
      ready: false,
      feedKey: 0,
    };
  },
  methods: {
    async fetchAll() {
      const settings = await fetch("/api/settings").then(r => r.json());
      this.tournamentLogo = settings.logo;

      const eventsData = await fetch("/scrape/events").then(r => r.json());
      this.events = eventsData.events || [];
      this.hooked = eventsData.hooked || [];

      const participantsRes = await fetch("/participants_data?limit=1000&offset=0");
      const participants = await participantsRes.json();
      const map = {};
      participants.forEach(p => {
        map[p.uid] = p.image_path || "/static/images/default.jpg";
      });

      this.boatImages = map;
      this.ready = true;

      // âœ… Force Vue to re-render feed after images are available
      this.feedKey += 1;
    },
    getBoatImage(uid) {
      return this.boatImages[uid] || "/static/images/default.jpg";
    },
    formatTime(iso) {
      const d = new Date(iso);
      return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
  },
  mounted() {
    this.fetchAll();
  }
}).mount('#app');
</script>
</body>
</html>
