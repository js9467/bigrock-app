<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Events Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3.4.15/dist/vue.global.prod.js"></script>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- HLS -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <link rel="stylesheet" href="/static/css/base.css" />
  <style>
    @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
    .message-strip-wrapper { position: relative; overflow: hidden; height: 2.25rem; background-color: #0b2a59; }
    .message-strip { display:inline-block; white-space:nowrap; font-size:1.05rem; font-weight:600; color:#fff; animation:marquee 40s linear infinite; will-change:transform; padding-left:100%; }
    .message-strip a { color:#facc15; text-decoration:underline; font-weight:700; padding:0 .5rem; }
    .message-strip-wrapper:hover .message-strip { animation-play-state: paused; cursor: pointer; }
    @keyframes pulse-slow { 0%,100%{opacity:1} 50%{opacity:.6} }
    .animate-pulse-slow { animation: pulse-slow 3s ease-in-out infinite; }
    .bg-brand-blue { background: #0b2a59; }
    .chip { background: rgba(250,204,21,.12); color:#fde68a; border:1px solid rgba(250,204,21,.35); }
  </style>
</head>

<body class="bg-gray-100 text-gray-900 font-sans h-screen overflow-hidden">
<div id="app" class="h-full flex flex-col">

  <!-- Header -->
  <header class="relative bg-brand-blue text-white px-4 py-3 shadow-lg shrink-0">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 items-center">

      <!-- Left: Logo + Tournament title & dates -->
      <div class="flex items-center gap-4">
        <img v-if="tournamentLogo" :src="tournamentLogo" alt="Tournament Logo"
             class="h-14 w-auto drop-shadow-lg rounded-md bg-white/5 p-1.5" />
        <div v-else class="h-14 w-14 rounded-md bg-white/10 animate-pulse-slow"></div>

        <div class="min-w-0">
          <div class="text-xl sm:text-2xl font-extrabold leading-tight truncate">
            {{ headerTournament || 'Tournament' }}
          </div>
          <div v-if="headerLabel" class="mt-1 inline-flex items-center gap-2 px-2.5 py-1 rounded-full chip text-xs sm:text-sm">
            <span>üìÖ</span>
            <span class="truncate">{{ headerLabel }}</span>
          </div>
          <div v-else class="text-white/60 text-sm">Loading dates‚Ä¶</div>
        </div>

        <!-- VHF live indicator -->
        <span v-if="radioPlaying" class="ml-2 text-sm font-semibold text-green-300 animate-pulse whitespace-nowrap flex items-center gap-1">
          üéß <span class="hidden sm:inline">VHF Playing</span>
        </span>
      </div>

      <!-- Middle (desktop): nav -->
      <nav class="hidden lg:flex items-center justify-center gap-3">
        <a href="/participants" class="px-3 py-2 text-white font-semibold border border-yellow-400 rounded-lg hover:bg-yellow-400 hover:text-blue-900 transition shadow-md hover:shadow-yellow-400/50">Participants</a>
        <a href="/leaderboard" class="px-3 py-2 text-white font-semibold border border-yellow-400 rounded-lg hover:bg-yellow-400 hover:text-blue-900 transition shadow-md hover:shadow-yellow-400/50">Leaderboard</a>
        <a href="/release-summary" class="px-3 py-2 text-white font-semibold border border-yellow-400 rounded-lg hover:bg-yellow-400 hover:text-blue-900 transition shadow-md hover:shadow-yellow-400/50">Releases</a>
        <a href="/settings-page" class="px-3 py-2 text-white font-semibold border border-yellow-400 rounded-lg hover:bg-yellow-400 hover:text-blue-900 transition shadow-md hover:shadow-yellow-400/50">Settings</a>
      </nav>

      <!-- Right: VHF controls -->
      <div class="flex items-center justify-end gap-3">
        <div class="flex items-center gap-3 bg-blue-900/50 backdrop-blur-sm rounded-full px-4 py-2 shadow-md border border-yellow-400/70">
          <button @click="toggleRadio"
                  class="px-4 py-2 w-28 sm:w-32 font-semibold border border-yellow-400 text-yellow-400 rounded-full hover:bg-yellow-400 hover:text-blue-900 transition shadow-md">
            {{ radioPlaying ? 'VHF OFF' : 'VHF ON' }}
          </button>
          <div class="flex items-center gap-2 text-sm text-white flex-nowrap">
            <span class="text-lg">üîä</span>
            <input type="range" min="0" max="100" v-model="settings.radio_volume"
                   @input="applyRadioVolume"
                   class="h-1 bg-yellow-400 rounded-lg appearance-none cursor-pointer w-24 sm:w-32 md:w-40 flex-shrink-0 accent-yellow-400">
            <span class="w-8 text-right text-xs">{{ settings.radio_volume }}%</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile nav -->
    <div class="mt-3 flex lg:hidden items-center justify-center gap-2">
      <a href="/participants" class="px-3 py-2 text-white font-semibold border border-yellow-400 rounded-lg hover:bg-yellow-400 hover:text-blue-900 transition">Participants</a>
      <a href="/leaderboard" class="px-3 py-2 text-white font-semibold border border-yellow-400 rounded-lg hover:bg-yellow-400 hover:text-blue-900 transition">Leaderboard</a>
      <a href="/release-summary" class="px-3 py-2 text-white font-semibold border border-yellow-400 rounded-lg hover:bg-yellow-400 hover:text-blue-900 transition">Releases</a>
      <a href="/settings-page" class="px-3 py-2 text-white font-semibold border border-yellow-400 rounded-lg hover:bg-yellow-400 hover:text-blue-900 transition">Settings</a>
    </div>

    <!-- Live Alert Bar -->
    <div v-if="messageQueue.length > 0" class="w-full mt-3 message-strip-wrapper">
      <div class="message-strip" v-html="currentMessage"></div>
    </div>

    <div class="absolute bottom-1 right-3 text-xs text-white/50 italic" v-if="version">v{{ version }}</div>
  </header>

  <!-- Main -->
  <main class="flex-1 overflow-hidden">
    <div class="flex h-full">

      <!-- Hooked Column -->
      <section class="w-full lg:w-1/3 bg-white border-r border-gray-300 overflow-y-auto">
        <div class="p-4 border-b text-xl font-bold bg-brand-blue text-white">
          Hooked Up <span v-if="hooked.length > 0">({{ hooked.length }})</span>
        </div>

        <div v-if="hooked.length === 0" class="p-4 text-gray-500 italic">No current hookups.</div>

        <article v-for="event in hooked" :key="event.timestamp + event.uid"
                 :class="['p-4 border-b hover:bg-gray-50 flex items-center gap-4', isFollowed(event.uid) ? 'bg-yellow-100' : '']">
          <div class="relative w-20 h-20 bg-gray-200 flex items-center justify-center rounded overflow-hidden">
            <img :src="getBoatImage(event.uid)" :key="boatImages[event.uid] || event.uid"
                 loading="lazy" class="w-20 h-20 object-cover rounded opacity-0 transition-opacity duration-500"
                 @load="$event.target.classList.add('opacity-100')" @error="onImageError($event)" alt="Boat image">
          </div>

          <div class="flex-1 min-w-0">
            <div class="text-lg font-semibold truncate">{{ event.boat }}</div>
            <div class="text-sm text-gray-600">Hooked Up at {{ formatTime(event.timestamp) }}</div>
          </div>

          <button @click="toggleFollow(event.boat)"
                  :class="isFollowed(event.uid) ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-300 hover:bg-gray-400'"
                  class="px-2 py-1 text-white rounded text-xs">
            {{ isFollowed(event.uid) ? 'Unfollow' : 'Follow' }}
          </button>
        </article>
      </section>

      <!-- Event Feed -->
      <section class="hidden lg:block w-2/3 overflow-y-auto event-feed">
        <div class="p-4 border-b text-xl font-bold flex justify-between items-center bg-brand-blue text-white">
          Event Feed
        </div>

        <!-- Followed Boats Chips -->
        <div v-if="followed.length" class="px-4 py-2 bg-white border-b border-gray-200">
          <div class="font-semibold text-gray-600 mb-1">Followed Boats:</div>
          <div class="flex flex-wrap gap-2">
            <div v-for="boat in followed" :key="boat"
                 class="flex items-center bg-yellow-200 text-yellow-900 font-semibold px-3 py-1 rounded-full shadow-sm">
              {{ boat }}
              <button @click="toggleFollow(boat)" class="ml-2 text-red-600 hover:text-red-800 font-bold text-sm">‚ùå</button>
            </div>
          </div>
        </div>

        <div v-if="loading" class="p-4 text-gray-500 italic">Loading events...</div>
        <div v-else-if="events.length === 0" class="p-4 text-gray-500 italic">No events to show.</div>

        <article v-for="event in events" :key="event.timestamp + event.uid"
                 :class="['p-4 border-b flex items-center gap-4 hover:bg-gray-50', isFollowed(event.uid) ? 'bg-yellow-100' : '']">
          <div class="relative w-20 h-20 bg-gray-200 flex items-center justify-center rounded overflow-hidden">
            <img :src="getBoatImage(event.uid)" :key="boatImages[event.uid] || event.uid"
                 loading="lazy" class="w-20 h-20 object-cover rounded opacity-0 transition-opacity duration-500"
                 @load="$event.target.classList.add('opacity-100')" @error="onImageError($event)" alt="Boat image">
          </div>

          <div class="flex-1 min-w-0">
            <div class="text-lg font-semibold truncate">{{ event.boat }}</div>
            <div class="text-sm text-gray-600">{{ event.event }} ‚Äî {{ formatTime(event.timestamp) }}</div>
            <div class="text-sm break-words">{{ event.details }}</div>
          </div>

          <button @click="toggleFollow(event.boat)"
                  :class="isFollowed(event.uid) ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-300 hover:bg-gray-400'"
                  class="px-2 py-1 text-white rounded text-xs">
            {{ isFollowed(event.uid) ? 'Unfollow' : 'Follow' }}
          </button>
        </article>
      </section>

    </div>
  </main>

  <audio id="radio-player" hidden></audio>
</div>

<script>
const { createApp } = Vue;

// iOS/Chrome auto-play unlock
document.addEventListener('click', () => {
  const unlock = new Audio(); unlock.muted = true; unlock.play().catch(()=>{});
}, { once: true });

const app = createApp({
  data() {
    return {
      // data
      events: [], hooked: [], boatImages: {},
      tournamentLogo: '', version: '', loading: false,
      followed: [], lastEventTimestamps: new Set(),
      settings: { followed_sound:'', boated_sound:'', hooked_sound:'', event_volume:80, radio_volume:30, sounds_enabled:true, data_source:'live', tournament:'' },
      radioPlaying:false, hls:null, error:null,
      messageQueue:[], currentMessage:'', messageTimer:null,
      // header
      headerTournament: '', headerLabel: ''
    };
  },

  async mounted() {
    await this.fetchSettings();
    await this.loadHeaderMeta();       // ‚Üê pulls name + dates
    this.loadTournamentLogo();

    await this.loadFollowed();
    this.setupMessages();
    this.startMessageRotation();
    this.fetchVersion();
    this.loadParticipants();
    this.fetchAll();

    setInterval(this.fetchAll, 30000);
    setInterval(this.loadParticipants, 10000);

    const player = document.getElementById('radio-player');
    if (player) player.volume = (this.settings.radio_volume || 30)/100;

    // quick console helpers
    window.playFollowed = () => this.playSound(this.settings.followed_sound);
    window.playBoated   = () => this.playSound(this.settings.boated_sound);
    window.playHooked   = () => this.playSound(this.settings.hooked_sound);
  },

  methods: {
    // ---------- Header meta (Tournament + Dates) ----------
    async loadHeaderMeta() {
      try {
        const [sRes, tRes] = await Promise.all([
          fetch('/api/settings'),
          fetch('/api/tournaments')
        ]);
        const s = await sRes.json();
        const t = await tRes.json();
        const name = (s && s.tournament) || '';
        const info = (t && t.tournaments) ? t.tournaments[name] : null;

        this.headerTournament = name || 'Tournament';
        this.headerLabel = (info && info.label) ? info.label : '';
      } catch (e) {
        console.warn('Header meta failed:', e);
      }
    },

    // ---------- Core data ----------
    async loadFollowed(){
      try{ const r=await fetch('/followed-boats'); this.followed=await r.json(); }
      catch{ this.followed=[]; }
    },
    async toggleFollow(boat){
      try{
        const r=await fetch('/followed-boats/toggle',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({boat})});
        const data=await r.json(); if(data.status==='ok') this.followed=data.followed_boats;
      }catch(e){ console.error('toggleFollow failed',e); }
    },
    isFollowed(uid){
      const norm=s=>(s||'').toLowerCase().replace(/[' ]/g,'_').replace(/\//g,'_');
      return this.followed.some(b=>norm(b)===norm(uid));
    },

    playSound(f){
      if(!f||!this.settings.sounds_enabled)return;
      let fn=f.trim();
      if(!fn.toLowerCase().endsWith('.mp3')) fn+='.mp3';
      const a=new Audio(`/static/sounds/${encodeURIComponent(fn)}`);
      a.volume=(this.settings.event_volume||80)/100; a.play().catch(()=>{});
    },

    fetchAll(){
      this.loading=true;
      Promise.all([
        fetch('/scrape/events').then(r=>r.json()),
        fetch('/hooked').then(r=>r.json())
      ]).then(([ed,hd])=>{
        const ne=ed.events||[], nh=hd.events||[];
        for(const e of ne){
          const k=e.timestamp+e.uid;
          const isNew=!this.lastEventTimestamps.has(k);
          this.lastEventTimestamps.add(k);
          if(isNew && this.settings.sounds_enabled){
            const et=(e.event||'').toLowerCase();
            if(et.includes('boated')) this.playSound(this.settings.boated_sound);
            else if(et.includes('hooked up')) this.playSound(this.settings.hooked_sound);
            else if(this.isFollowed(e.uid)) this.playSound(this.settings.followed_sound);
          }
        }
        this.events=ne; this.hooked=nh; this.loading=false; this.updateDemoMessage();
      }).catch(()=>{ this.loading=false; });
    },

    fetchSettings(){
      return fetch('/api/settings').then(r=>r.json()).then(d=>{ this.settings={...this.settings,...d}; });
    },
    fetchVersion(){ fetch('/api/version').then(r=>r.json()).then(d=>{ this.version=d.version; }); },

    loadTournamentLogo(){
      fetch('/api/settings').then(r=>r.json()).then(s=>{
        const t=s.tournament;
        fetch('https://js9467.github.io/Brtourney/settings.json').then(r=>r.json()).then(all=>{
          this.tournamentLogo = (all && all[t] && all[t].logo) ? all[t].logo : '';
        });
      });
    },

    loadParticipants(){
      fetch('/participants_data').then(r=>r.json()).then(d=>{
        const imgs={...this.boatImages};
        for(const p of (d.participants||[])) imgs[p.uid]=p.image_path;
        imgs['palmer_lou']='/static/images/palmer_lou.jpg';
        this.boatImages=imgs;
      });
    },
    getBoatImage(uid){ return this.boatImages[uid] || '/static/images/bigrock.webp'; },
    onImageError(e){ e.target.src='/static/images/bigrock.webp'; },

    formatTime(ts){
      const dt=new Date(ts);
      try{
        return dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});
      }catch{ return dt.toISOString().slice(11,16); }
    },

    applyRadioVolume(){
      const p=document.getElementById('radio-player'); if(p) p.volume=(this.settings.radio_volume||30)/100;
    },

    toggleRadio(){
      const p=document.getElementById('radio-player'); if(!p) return;
      if(this.radioPlaying){ p.pause(); this.radioPlaying=false; return; }
      fetch('/api/settings').then(r=>r.json()).then(s=>{
        const t=s.tournament;
        fetch('https://js9467.github.io/Brtourney/settings.json').then(r=>r.json()).then(all=>{
          const stream=all[t]?.stream||all[t]?.fallback_stream;
          if(!stream){ alert('No VHF stream available.'); return; }
          if(Hls.isSupported()){
            if(!this.hls) this.hls=new Hls();
            this.hls.loadSource(stream);
            this.hls.attachMedia(p);
            this.hls.on(Hls.Events.MANIFEST_PARSED,()=>{ p.play(); });
          }else{ p.src=stream; p.play(); }
          this.radioPlaying=true;
        });
      });
    },

    // ---------- Messages ----------
    setupMessages(){
      this.messageQueue=[];
      if(!navigator.onLine) this.enqueueMessage("üì° Offline. <a href='/settings-page'>Connect to WiFi</a>");
      this.updateDemoMessage();
    },
    updateDemoMessage(){
      if((this.settings.data_source||'').toLowerCase()==='demo'){
        this.enqueueMessage("üé£ You are in demo mode. Events are generated from prior tournaments. ‚Äî <a href='#' onclick='window.vm.injectPalmerLouEvent();return false;'>Click to simulate a ‚Äúfish boated‚Äù event!</a>");
      }
    },
    enqueueMessage(m){ if(this.messageQueue.indexOf(m)===-1) this.messageQueue.push(m); },
    startMessageRotation(){
      if(this.messageQueue.length===0) return;
      let i=0; this.currentMessage=this.messageQueue[i];
      if(this.messageTimer) clearInterval(this.messageTimer);
      this.messageTimer=setInterval(()=>{ i=(i+1)%this.messageQueue.length; this.currentMessage=this.messageQueue[i]; },7000);
    },

    // Demo helper
    injectPalmerLouEvent(){
      const now = new Date().toISOString();
      const newEvent = { timestamp: now, event: "Boated", boat: "Palmer Lou", uid: "palmer_lou", details: "Palmer Lou boated a massive blue marlin and is headed to the scales!" };
      this.events.unshift(newEvent);
      this.$nextTick(()=>{ const feed=document.querySelector('.event-feed'); if(feed) feed.scrollTop=0; });
      this.playSound(this.settings.boated_sound || this.settings.followed_sound || 'generic_005_104781');
      console.log("üé£ Injected Palmer Lou demo event (frontend only)");
    }
  }
});

const vm = app.mount('#app');
window.vm = vm; // for console debugging
</script>

</body>
</html>
