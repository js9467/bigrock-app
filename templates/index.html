<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Events Feed</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <link rel="stylesheet" href="/static/css/base.css">
  <style>
@keyframes marquee {
  0% { transform: translateX(100%); }
  100% { transform: translateX(-100%); }
}

.text-center a {
  color: #facc15;
  text-decoration: underline;
  font-weight: bold;
}
.message-strip-wrapper {
  position: relative;
  overflow: hidden;
  height: 2.25rem;
  background-color: #002855;
}

.message-strip {
  display: inline-block;
  white-space: nowrap;
  font-size: 1.2rem;
  font-weight: 600;
  color: white;
  animation: marquee 40s linear infinite;
  will-change: transform;
  padding-left: 100%;
}

.message-strip a {
  color: #facc15;
  text-decoration: underline;
  font-weight: bold;
  padding: 0 0.5rem;
}

.message-strip-wrapper:hover .message-strip {
  animation-play-state: paused;
  cursor: pointer;
}
</style>

</head>
<body class="bg-gray-100 text-gray-900 font-sans">
<div id="app">
  <!-- Header -->
  <header class="bg-brand-blue text-white px-4 py-3 shadow-md relative">
  <div class="flex items-center justify-between gap-4 flex-wrap w-full">
    <!-- Left: Logo + VHF playing -->
    <div class="flex items-center gap-4">
      <img v-if="tournamentLogo" :src="tournamentLogo" alt="Tournament Logo" class="h-14 drop-shadow">
      <span v-else class="text-white text-base">Loading Logo...</span>
      <span v-if="radioPlaying" class="text-sm text-green-300 animate-pulse ml-2">üéß VHF Playing</span>
    </div>

    <!-- Right: Buttons -->
    <div class="flex gap-4 items-start flex-wrap justify-end ml-auto">
      <div class="flex flex-col items-center">
        <button @click="toggleRadio"
                class="px-4 py-2 w-36 text-white font-semibold border border-white rounded hover:bg-white hover:text-blue-900 transition">
          {{ radioPlaying ? 'VHF OFF' : 'VHF ON' }}
        </button>
        <div class="mt-1 flex items-center text-sm text-white gap-2 w-36 justify-center">
          <span class="text-lg">üîä</span>
          <input type="range" min="0" max="100" v-model="settings.radio_volume"
                 @input="applyRadioVolume" @change="saveRadioVolume"
                 class="w-40 h-1 bg-white rounded-lg appearance-none cursor-pointer">
          <span class="w-8 text-right text-xs">{{ settings.radio_volume }}%</span>
        </div>
      </div>
      <a href="/participants" class="px-3 py-2 w-36 text-center text-white font-semibold border border-white rounded hover:bg-white hover:text-blue-900 transition">Participants</a>
      <a href="/leaderboard" class="px-3 py-2 w-36 text-center text-white font-semibold border border-white rounded hover:bg-white hover:text-blue-900 transition">Leaderboard</a>
      <a href="/release-summary" class="px-3 py-2 w-36 text-center text-white font-semibold border border-white rounded hover:bg-white hover:text-blue-900 transition">Releases</a>
      <a href="/settings-page" class="w-12 h-12 flex items-center justify-center text-white text-xl border border-white rounded hover:bg-white hover:text-blue-900 transition">‚öô</a>
    </div>
  </div>

  <!-- Rotating Message -->
  <div v-if="messageQueue.length > 0" class="w-full bg-brand-blue py-1">
    <div class="text-white text-center text-lg font-semibold px-4" v-html="currentMessage"></div>
  </div>

  <!-- Version -->
  <div class="absolute bottom-1 left-3 text-xs text-white opacity-70" v-if="version">
    v{{ version }}
  </div>
</header>

  <div class="flex h-screen overflow-hidden">
    <div class="w-1/3 bg-white border-r border-gray-300 overflow-y-auto">
      <div class="p-4 border-b text-xl font-bold bg-brand-blue text-white">Hooked Up</div>
      <div v-if="hooked.length === 0" class="p-4 text-gray-500 italic">No current hookups.</div>
      <div v-for="event in hooked" :key="event.timestamp + event.uid"
           :class="['p-4 border-b hover:bg-gray-50 flex items-center gap-4', isFollowed(event.uid) ? 'bg-yellow-100' : '']">
        <img :src="getBoatImage(event.uid)" class="w-20 h-20 object-cover rounded" onerror="this.style.display='none'" />
        <div>
          <div class="text-lg font-semibold">{{ event.boat }}</div>
          <div class="text-sm text-gray-600">Hooked Up at {{ formatTime(event.timestamp) }}</div>
        </div>
      </div>
    </div>

    <div class="w-2/3 overflow-y-auto">
      <div class="p-4 border-b text-xl font-bold flex justify-between items-center bg-brand-blue text-white">
        Event Feed
      </div>
      <div v-if="loading" class="p-4 text-gray-500 italic">Loading events...</div>
      <div v-else-if="events.length === 0" class="p-4 text-gray-500 italic">No events to show.</div>
      <div v-for="event in events" :key="event.timestamp + event.uid"
           :class="['p-4 border-b flex items-center gap-4 hover:bg-gray-50', isFollowed(event.uid) ? 'bg-yellow-100' : '']">
        <img :src="getBoatImage(event.uid)" class="w-20 h-20 object-cover rounded" onerror="this.style.display='none'" />
        <div>
          <div class="text-lg font-semibold">{{ event.boat }}</div>
          <div class="text-sm text-gray-600">{{ event.event }} ‚Äî {{ formatTime(event.timestamp) }}</div>
          <div class="text-sm">{{ event.details }}</div>
        </div>
      </div>
    </div>
  </div>

  <audio id="radio-player" hidden></audio>
</div>

<script>
const { createApp } = Vue;

const app = createApp({
  data() {
    return {
      events: [],
      hooked: [],
      boatImages: {},
      tournamentLogo: '',
      version: '',
      loading: false,
      followed: JSON.parse(localStorage.getItem('followedBoats') || '[]'),
      lastEventTimestamps: new Set(),
      settings: {
        followed_sound: 'followed-activity',
        boated_sound: '1904_champagne-cork-pop-02',
        event_volume: 80,
        radio_volume: 30,
        sounds_enabled: true,
        data_source: 'live',
        tournament: ''
      },
      radioPlaying: false,
      hls: null,
      error: null,
      messageQueue: [],
      currentMessage: '',
      messageTimer: null,
      firstLoad: true
    };
  },

  mounted() {
    this.fetchSettings().then(() => {
      this.setupMessages();
      this.startMessageRotation();
      this.fetchVersion();
      this.loadTournamentLogo();
      this.loadParticipants();
      this.fetchAll();
      setInterval(this.fetchAll, 30000);
    });

    // üîπ Auto-refresh hooked feed every 5 seconds
    setInterval(this.fetchHooked, 5000);

    const player = document.getElementById('radio-player');
    if (player) player.volume = this.settings.radio_volume / 100;

    const storedPlaying = localStorage.getItem('radioPlaying') === 'true';
    if (storedPlaying) {
      this.radioPlaying = !player.paused && !player.ended && player.currentTime > 0;
      if (!this.radioPlaying) {
        console.log('üîÑ Auto-fix: forcing VHF to off because player is paused.');
        localStorage.setItem('radioPlaying', 'false');
      }
    } else {
      this.radioPlaying = false;
    }

    window.addEventListener('online', this.setupMessages);
    window.addEventListener('offline', this.setupMessages);
  },

  methods: {
    applyRadioVolume() { /* unchanged */ },
    toggleRadio() { /* unchanged */ },
    fetchSettings() {
      return fetch('/api/settings')
        .then(res => res.json())
        .then(data => { this.settings = { ...this.settings, ...data }; });
    },
    fetchVersion() {
      fetch('/api/version')
        .then(res => res.json())
        .then(data => { this.version = data.version; });
    },
    setupMessages() { /* unchanged */ },
    enqueueMessage(msg) { /* unchanged */ },
    startMessageRotation() { /* unchanged */ },

    fetchAll() {
      this.loading = true;
      Promise.all([
        fetch('/scrape/events').then(res => res.json()),
        fetch('/hooked').then(res => res.json())
      ])
        .then(([eventsData, hookedData]) => {
          const newEvents = eventsData.events || [];
          const newHooked = hookedData.events || [];

          for (const event of newEvents) {
            const key = event.timestamp + event.uid;
            const isNew = !this.lastEventTimestamps.has(key);
            this.lastEventTimestamps.add(key);

            if (isNew && !this.firstLoad && this.settings.sounds_enabled) {
              if (event.event.toLowerCase().includes('boated')) {
                this.playSound(this.settings.boated_sound);
              } else if (this.isFollowed(event.uid)) {
                this.playSound(this.settings.followed_sound);
              }
            }
          }

          this.firstLoad = false;
          this.events = newEvents;
          this.hooked = newHooked;
          this.loading = false;
        })
        .catch(err => {
          console.error("‚ùå Fetch error:", err);
          this.loading = false;
        });
    },

    // üîπ Fetch hooked feed separately for auto-refresh
    fetchHooked() {
      fetch('/hooked')
        .then(res => res.json())
        .then(data => {
          if (data.status === 'ok') {
            this.hooked = data.events || [];
          }
        })
        .catch(err => console.error('‚ùå Hooked fetch error:', err));
    },

    getBoatImage(uid) { return this.boatImages[uid] || ''; },
    loadParticipants() { /* unchanged */ },
    loadTournamentLogo() { /* unchanged */ },
    formatTime(ts) { /* unchanged */ },
    isFollowed(uid) { return this.followed.includes(uid); },
    playSound(filename) { /* unchanged */ }
  }

}).mount('#app');

window.injectTestEvent = function () { /* unchanged */ };
</script>
</body>
</html>