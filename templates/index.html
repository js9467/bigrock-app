<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Events Feed</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <link rel="stylesheet" href="/static/css/base.css">

  <style>
    @keyframes marquee {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }
    .message-strip-wrapper { position: relative; overflow: hidden; height: 2.25rem; background-color: #002855; }
    .message-strip {
      display: inline-block; white-space: nowrap; font-size: 1.2rem; font-weight: 600; color: white;
      animation: marquee 40s linear infinite; will-change: transform; padding-left: 100%;
    }
    .message-strip a { color: #facc15; text-decoration: underline; font-weight: bold; padding: 0 0.5rem; }
    .message-strip-wrapper:hover .message-strip { animation-play-state: paused; cursor: pointer; }
    @keyframes pulse-slow { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .animate-pulse-slow { animation: pulse-slow 3s ease-in-out infinite; }
  </style>
</head>

<body class="bg-gray-100 text-gray-900 font-sans">
<div id="app">
<!-- Header -->
<header class="relative bg-brand-blue text-white px-4 py-3 shadow-lg">
  <div class="flex flex-col sm:flex-row items-center justify-between gap-6 w-full">
    <!-- Left: Logo + VHF Playing -->
    <div class="flex items-center gap-4">
      <img v-if="tournamentLogo" :src="tournamentLogo" alt="Tournament Logo" class="h-14 drop-shadow-lg animate-pulse-slow">
      <span v-else class="text-white text-base animate-pulse">Loading Logo...</span>

      <!-- VHF Active Indicator -->
      <span v-if="radioPlaying" class="text-sm font-semibold text-green-300 animate-pulse whitespace-nowrap flex items-center gap-1">
        ðŸŽ§ <span class="hidden sm:inline">VHF Playing</span>
      </span>
    </div>

    <!-- Right: Controls & Nav -->
    <div class="flex flex-col sm:flex-row sm:flex-wrap items-center gap-6 w-full sm:w-auto sm:ml-auto">
      <!-- VHF Controls -->
      <div class="flex items-center gap-3 bg-blue-900/50 backdrop-blur-sm rounded-full px-4 py-2 shadow-md border border-yellow-400/70 animate-pulse-slow">
        <button @click="toggleRadio"
                class="px-4 py-2 w-28 sm:w-32 font-semibold border border-yellow-400 text-yellow-400 rounded-full hover:bg-yellow-400 hover:text-blue-900 transition shadow-md">
          {{ radioPlaying ? 'VHF OFF' : 'VHF ON' }}
        </button>
        <div class="flex items-center gap-2 text-sm text-white flex-nowrap">
          <span class="text-lg">ðŸ”Š</span>
          <input type="range" min="0" max="100" v-model="settings.radio_volume"
                 @input="applyRadioVolume" class="h-1 bg-yellow-400 rounded-lg appearance-none cursor-pointer w-24 sm:w-32 md:w-40 flex-shrink-0 accent-yellow-400">
          <span class="w-8 text-right text-xs">{{ settings.radio_volume }}%</span>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="grid grid-cols-2 sm:flex gap-2 sm:gap-4 w-full sm:w-auto text-center">
        <a href="/participants" class="px-3 py-2 w-full sm:w-36 text-white font-semibold border border-yellow-400 rounded-lg hover:bg-yellow-400 hover:text-blue-900 transition shadow-md hover:shadow-yellow-400/50">Participants</a>
        <a href="/leaderboard" class="px-3 py-2 w-full sm:w-36 text-white font-semibold border border-yellow-400 rounded-lg hover:bg-yellow-400 hover:text-blue-900 transition shadow-md hover:shadow-yellow-400/50">Leaderboard</a>
        <a href="/release-summary" class="px-3 py-2 w-full sm:w-36 text-white font-semibold border border-yellow-400 rounded-lg hover:bg-yellow-400 hover:text-blue-900 transition shadow-md hover:shadow-yellow-400/50">Releases</a>
        <a href="/settings-page" class="w-12 h-12 flex items-center justify-center text-white text-xl border border-yellow-400 rounded-full hover:bg-yellow-400 hover:text-blue-900 transition shadow-md hover:shadow-yellow-400/50">âš™</a>
      </div>
    </div>
  </div>

  <!-- Live Alert Bar -->
  <div v-if="messageQueue.length > 0" class="w-full mt-3">
    <div class="bg-yellow-400 text-blue-900 font-extrabold px-4 py-2 text-center text-lg leading-snug break-words whitespace-normal rounded shadow-inner shadow-yellow-500/50 animate-pulse-slow" v-html="currentMessage"></div>
    <button v-if="settings.data_source === 'demo'" 
            @click="injectTestEvent" 
            class="absolute top-2 right-2 text-xs font-bold text-blue-900 bg-white/80 hover:bg-white px-2 py-0.5 rounded shadow">
      + Demo Event
    </button>
  </div>

  <!-- Subtle Version -->
  <div class="absolute bottom-1 right-3 text-xs text-white/50 italic" v-if="version">
    v{{ version }}
  </div>
</header>

<div class="flex h-screen overflow-hidden">
  <!-- Hooked Column -->
  <div class="w-1/3 bg-white border-r border-gray-300 overflow-y-auto">
    <div class="p-4 border-b text-xl font-bold bg-brand-blue text-white">Hooked Up</div>
    <div v-if="hooked.length === 0" class="p-4 text-gray-500 italic">No current hookups.</div>

    <div v-for="event in hooked" :key="event.timestamp + event.uid"
         :class="['p-4 border-b hover:bg-gray-50 flex items-center gap-4', isFollowed(event.uid) ? 'bg-yellow-100' : '']">

      <div class="relative w-20 h-20 bg-gray-200 flex items-center justify-center rounded overflow-hidden">
        <!-- Spinner -->
        <div v-if="!boatImages[event.uid]" class="absolute inset-0 flex items-center justify-center">
          <svg class="animate-spin h-6 w-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
          </svg>
        </div>
        <img :src="getBoatImage(event.uid)" :key="boatImages[event.uid] || event.uid"
             loading="lazy" class="w-20 h-20 object-cover rounded opacity-0 transition-opacity duration-500"
             @load="$event.target.classList.add('opacity-100')" @error="onImageError($event)">
      </div>

      <div>
        <div class="text-lg font-semibold">{{ event.boat }}</div>
        <div class="text-sm text-gray-600">Hooked Up at {{ formatTime(event.timestamp) }}</div>
      </div>
    </div>
  </div>

  <!-- Event Feed -->
  <div class="w-2/3 overflow-y-auto">
    <div class="p-4 border-b text-xl font-bold flex justify-between items-center bg-brand-blue text-white">
      Event Feed
    </div>
    <div v-if="loading" class="p-4 text-gray-500 italic">Loading events...</div>
    <div v-else-if="events.length === 0" class="p-4 text-gray-500 italic">No events to show.</div>

    <div v-for="event in events" :key="event.timestamp + event.uid"
         :class="['p-4 border-b flex items-center gap-4 hover:bg-gray-50', isFollowed(event.uid) ? 'bg-yellow-100' : '']">

      <div class="relative w-20 h-20 bg-gray-200 flex items-center justify-center rounded overflow-hidden">
        <!-- Spinner -->
        <div v-if="!boatImages[event.uid]" class="absolute inset-0 flex items-center justify-center">
          <svg class="animate-spin h-6 w-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
          </svg>
        </div>
        <img :src="getBoatImage(event.uid)" :key="boatImages[event.uid] || event.uid"
             loading="lazy" class="w-20 h-20 object-cover rounded opacity-0 transition-opacity duration-500"
             @load="$event.target.classList.add('opacity-100')" @error="onImageError($event)">
      </div>

      <div>
        <div class="text-lg font-semibold">{{ event.boat }}</div>
        <div class="text-sm text-gray-600">{{ event.event }} â€” {{ formatTime(event.timestamp) }}</div>
        <div class="text-sm">{{ event.details }}</div>
      </div>
    </div>
  </div>
</div>

<audio id="radio-player" hidden></audio>
</div>

<script>
const { createApp } = Vue;

document.addEventListener('click', () => {
  const unlock = new Audio();
  unlock.muted = true;
  unlock.play().catch(() => {});
}, { once: true });

const vm = createApp({
  data() {
    return {
      events: [],
      hooked: [],
      boatImages: {},
      tournamentLogo: '',
      version: '',
      loading: false,
      followed: JSON.parse(localStorage.getItem('followedBoats') || '[]'),
      lastEventTimestamps: new Set(),
      settings: { followed_sound: 'fishing reel', boated_sound: 'fishing reel', event_volume: 80, radio_volume: 30, sounds_enabled: true, data_source: 'live', tournament: '' },
      radioPlaying: false,
      hls: null,
      error: null,
      messageQueue: [],
      currentMessage: '',
      messageTimer: null
    };
  },

  mounted() {
    this.fetchSettings().then(() => {
      this.setupMessages();
      this.startMessageRotation();
      this.fetchVersion();
      this.loadTournamentLogo();
      this.loadParticipants();
      this.fetchAll();
      setInterval(this.fetchAll, 30000); // events refresh
      setInterval(this.loadParticipants, 10000); // poll images every 10s
    });

    const player = document.getElementById('radio-player');
    if (player) player.volume = this.settings.radio_volume / 100;
  },

  methods: {
    playSound(filename) {
      if (!filename || !this.settings.sounds_enabled) return;
      let cleanName = filename.trim();
      if (!cleanName.toLowerCase().endsWith(".mp3")) cleanName += ".mp3";
      const audio = new Audio(`/static/sounds/${cleanName}`);
      audio.volume = (this.settings.event_volume || 80) / 100;
      audio.play().catch(()=>{});
    },

    fetchAll() {
      this.loading = true;
      Promise.all([
        fetch('/scrape/events').then(res => res.json()),
        fetch('/hooked').then(res => res.json())
      ])
        .then(([eventsData, hookedData]) => {
          const newEvents = eventsData.events || [];
          const newHooked = hookedData.events || [];
          for (const event of newEvents) {
            const key = event.timestamp + event.uid;
            const isNew = !this.lastEventTimestamps.has(key);
            this.lastEventTimestamps.add(key);
            if (isNew && this.settings.sounds_enabled) {
              const etype = (event.event || "").toLowerCase();
              if (etype.includes("boated")) this.playSound(this.settings.boated_sound);
              else if (this.isFollowed(event.uid)) this.playSound(this.settings.followed_sound);
            }
          }
          this.events = newEvents;
          this.hooked = newHooked;
          this.loading = false;
        })
        .catch(err => { console.error("âŒ Fetch error:", err); this.loading = false; });
    },

    fetchSettings() { return fetch('/api/settings').then(res=>res.json()).then(data=>{ this.settings={...this.settings,...data}; }); },
    fetchVersion() { fetch('/api/version').then(res=>res.json()).then(data=>{ this.version=data.version; }); },
    loadTournamentLogo() {
      fetch('/api/settings').then(res=>res.json()).then(settings=>{
        const tournament = settings.tournament;
        fetch('https://js9467.github.io/Brtourney/settings.json').then(res=>res.json()).then(all=>{
          this.tournamentLogo = all[tournament]?.logo || '';
        });
      });
    },

    loadParticipants() {
      fetch('/participants_data')
        .then(res => res.json())
        .then(data => {
          const images = { ...this.boatImages }; // keep existing to avoid flicker
          for (const p of data.participants) images[p.uid] = p.image_path;
          images["palmer_lou"] = "/static/images/palmer_lou.jpg";
          this.boatImages = images;
        });
    },

    getBoatImage(uid) { return this.boatImages[uid] || '/static/images/bigrock.webp'; },
    onImageError(e) { e.target.src = '/static/images/bigrock.webp'; },
    formatTime(ts) { const dt=new Date(ts); return dt.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true}); },
    isFollowed(uid) { return this.followed.includes(uid); },

    applyRadioVolume() { const player=document.getElementById('radio-player'); if(player) player.volume=this.settings.radio_volume/100; },
    toggleRadio() { /* unchanged for brevity */ },

    setupMessages() {
      this.messageQueue=[];
      if(!navigator.onLine) this.enqueueMessage(`ðŸ“¡ Offline. <a href='/settings-page'>Connect to WiFi</a>`);
      if(this.settings.data_source==='demo') this.enqueueMessage(`Demo mode: events emulated.`);
      if(this.radioPlaying && this.error) this.enqueueMessage(this.error);
    },
    enqueueMessage(msg){ if(!this.messageQueue.includes(msg)) this.messageQueue.push(msg); },
    startMessageRotation(){ if(this.messageQueue.length===0) return; let i=0; this.currentMessage=this.messageQueue[i]; if(this.messageTimer) clearInterval(this.messageTimer); this.messageTimer=setInterval(()=>{i=(i+1)%this.messageQueue.length; this.currentMessage=this.messageQueue[i];},7000); }
  }
}).mount('#app');

window.vm = vm;
</script>
</body>
</html>
