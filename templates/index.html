<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tournament Events Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.8/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/css/base.css" />
  <style>
    body { touch-action: manipulation; }
    .toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 9999;
      padding: 0.75rem 1rem;
      border-radius: 0.375rem;
      font-weight: 600;
      color: white;
    }
    .toast-success { background-color: #16a34a; }
    .toast-error { background-color: #dc2626; }
    .vhf-indicator {
      display: inline-block;
      margin-left: 8px;
      width: 10px;
      height: 10px;
      background-color: #16a34a;
      border-radius: 50%;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 50%, 100% { opacity: 1; }
      25%, 75% { opacity: 0; }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
<div id="app">
  <header class="bg-brand-blue text-white flex items-center justify-between px-4 py-3 shadow-md">
    <div class="flex items-center space-x-4">
      <img v-if="tournamentLogo" :src="tournamentLogo" alt="Tournament Logo" class="h-14 drop-shadow">
      <span v-else class="text-white text-base">Loading Logo...</span>
    </div>
    <div class="flex items-center space-x-4">
      <button @click="toggleRadio" class="bg-white text-brand-blue px-4 py-2 rounded font-bold">
        {{ radioPlaying ? 'VHF On' : 'VHF Off' }}
        <span v-if="radioPlaying" class="vhf-indicator"></span>
      </button>
    </div>
  </header>

  <main class="p-4">
    <h2 class="text-xl font-bold mb-2">Live Tournament Feed</h2>
    <div v-if="loading" class="text-gray-500">Loading events...</div>
    <div v-else>
      <div v-for="event in events" :key="event.id" class="mb-4 p-4 bg-white shadow rounded">
        <p class="font-semibold">{{ event.time }} ‚Äî {{ event.boat }}</p>
        <p class="text-gray-700">{{ event.details }}</p>
      </div>
    </div>
  </main>

  <div v-if="toastMessage" :class="['toast', toastType]">{{ toastMessage }}</div>

  <audio ref="audioPlayer" preload="auto"></audio>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      events: [],
      loading: true,
      toastMessage: '',
      toastType: '',
      radioPlaying: false,
      hls: null,
      settings: {},
      tournamentLogo: null,
      primaryStream: '',
      fallbackStream: '',
    };
  },
  methods: {
    async fetchSettings() {
      try {
        const res = await axios.get('/api/settings');
        this.settings = res.data;
        this.fallbackStream = this.settings.fallback_stream || '';
        const tournament = this.settings.tournament;
        const allTournaments = await axios.get('https://js9467.github.io/Brtourney/settings.json');
        const entry = allTournaments.data[tournament] || {};
        this.primaryStream = entry.stream || '';
        this.tournamentLogo = entry.logo || null;
      } catch (err) {
        this.showToast('Failed to load tournament settings', 'toast-error');
        console.error(err);
      }
    },
    async fetchEvents() {
      try {
        const res = await axios.get('/events');
        this.events = res.data || [];
      } catch (err) {
        console.error('Event fetch failed:', err);
      } finally {
        this.loading = false;
      }
    },
    showToast(msg, type = 'toast-success') {
      this.toastMessage = msg;
      this.toastType = type;
      setTimeout(() => this.toastMessage = '', 3000);
    },
    toggleRadio() {
      const player = this.$refs.audioPlayer;

      const playStream = (url, isFallback = false) => {
        if (this.hls) {
          this.hls.destroy();
          this.hls = null;
        }

        if (Hls.isSupported()) {
          this.hls = new Hls();
          this.hls.loadSource(url);
          this.hls.attachMedia(player);
          this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
            player.volume = this.settings.radio_volume || 0.3;
            player.play().then(() => {
              this.radioPlaying = true;
              this.showToast('üì° VHF Stream Playing');
            }).catch(err => {
              console.error('üîä HLS play failed:', err);
              if (!isFallback && this.fallbackStream) {
                playStream(this.fallbackStream, true);
              } else {
                this.showToast('üîá Stream unavailable', 'toast-error');
              }
            });
          });
        } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
          player.src = url;
          player.volume = this.settings.radio_volume || 0.3;
          player.play().then(() => {
            this.radioPlaying = true;
            this.showToast('üì° VHF Stream Playing');
          }).catch(err => {
            console.error('üîä Native HLS play failed:', err);
            if (!isFallback && this.fallbackStream) {
              playStream(this.fallbackStream, true);
            } else {
              this.showToast('üîá Stream unavailable', 'toast-error');
            }
          });
        } else {
          this.showToast('‚ùå Audio format not supported', 'toast-error');
        }
      };

      if (this.radioPlaying) {
        if (this.hls) {
          this.hls.destroy();
          this.hls = null;
        }
        player.pause();
        player.src = '';
        this.radioPlaying = false;
        this.showToast('üõë VHF Stream Stopped', 'toast-info');
      } else {
        player.src = '';
        playStream(this.primaryStream || this.fallbackStream);
      }
    }
  },
  async mounted() {
    await this.fetchSettings();
    await this.fetchEvents();
  }
}).mount("#app");
</script>
</body>
</html>