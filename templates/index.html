<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Events Feed</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <link rel="stylesheet" href="/static/css/base.css">
 <style>
  body { touch-action: manipulation; }

  @keyframes marquee {
    0% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
  }

  .animate-marquee {
    animation: marquee 25s linear infinite;
    will-change: transform;
  }

  .message-strip a {
    color: #facc15 !important; /* Bright yellow */
    text-decoration: underline;
  }

  .message-strip {
    font-size: 1.1rem; /* Larger text for kiosk */
    font-weight: 600;
    white-space: nowrap;
    padding-left: 100%; /* Start off-screen */
  }

  .message-error { color: #f87171; }
  .message-warning { color: #facc15; }
  .message-info { color: #93c5fd; }
</style>

<body class="bg-gray-100 text-gray-900 font-sans">
<div id="app">
  <!-- Header -->
  <header class="bg-brand-blue text-white px-4 py-3 shadow-md relative">
    <div class="flex items-center justify-between gap-4 flex-wrap w-full">
      <!-- Left: Logo + VHF playing -->
      <div class="flex items-center gap-4">
        <img v-if="tournamentLogo" :src="tournamentLogo" alt="Tournament Logo" class="h-14 drop-shadow">
        <span v-else class="text-white text-base">Loading Logo...</span>
        <span v-if="radioPlaying" class="text-sm text-green-300 animate-pulse ml-2">🎧 VHF Playing</span>
      </div>

      <!-- Center: Ticker area -->
<div v-if="messageQueue.length > 0" class="relative flex-1 overflow-hidden h-8 bg-brand-blue text-white">
  <div class="absolute w-full h-full overflow-hidden">
    <div class="message-strip animate-marquee" v-html="combinedMessages"></div>
  </div>
</div>
['absolute whitespace-nowrap text-sm font-semibold text-white', messageQueue.length > 1 ? 'animate-marquee' : '']" v-html="combinedMessages"></div>
      </div>

      <!-- Right: Buttons -->
      <div class="flex gap-4 items-start">
        <div class="flex flex-col items-center">
          <button @click="toggleRadio"
                  class="px-4 py-2 w-36 text-white font-semibold border border-white rounded hover:bg-white hover:text-blue-900 transition">
            {{ radioPlaying ? 'VHF OFF' : 'VHF ON' }}
          </button>
          <div class="mt-1 flex items-center text-sm text-white gap-2 w-36 justify-center">
            <span class="text-lg">🔊</span>
            <input type="range" min="0" max="100" v-model="settings.radio_volume" @change="saveRadioVolume"
                   class="w-40 h-1 bg-white rounded-lg appearance-none cursor-pointer">
            <span class="w-8 text-right text-xs">{{ settings.radio_volume }}%</span>
          </div>
        </div>
        <a href="/participants" class="px-3 py-2 w-36 text-center text-white font-semibold border border-white rounded hover:bg-white hover:text-blue-900 transition">Participants</a>
        <a href="/leaderboard" class="px-3 py-2 w-36 text-center text-white font-semibold border border-white rounded hover:bg-white hover:text-blue-900 transition">Leaderboard</a>
        <a href="/catch-summary" class="px-3 py-2 w-36 text-center text-white font-semibold border border-white rounded hover:bg-white hover:text-blue-900 transition">Catch Summary</a>
        <a href="/settings-page" class="w-12 h-12 flex items-center justify-center text-white text-xl border border-white rounded hover:bg-white hover:text-blue-900 transition">⚙</a>
      </div>
    </div>
    <div class="absolute bottom-1 left-3 text-xs text-white opacity-70" v-if="version">
      v{{ version }}
    </div>
  </header>

  <div class="flex h-screen overflow-hidden">
    <div class="w-1/3 bg-white border-r border-gray-300 overflow-y-auto">
      <div class="p-4 border-b text-xl font-bold bg-brand-blue text-white">Hooked Up</div>
      <div v-if="hooked.length === 0" class="p-4 text-gray-500 italic">No current hookups.</div>
      <div v-for="event in hooked" :key="event.timestamp + event.uid"
           :class="['p-4 border-b hover:bg-gray-50 flex items-center gap-4', isFollowed(event.uid) ? 'bg-yellow-100' : '']">
        <img :src="getBoatImage(event.uid)" class="w-20 h-20 object-cover rounded" onerror="this.style.display='none'" />
        <div>
          <div class="text-lg font-semibold">{{ event.boat }}</div>
          <div class="text-sm text-gray-600">Hooked Up at {{ formatTime(event.timestamp) }}</div>
        </div>
      </div>
    </div>

    <div class="w-2/3 overflow-y-auto">
      <div class="p-4 border-b text-xl font-bold flex justify-between items-center bg-brand-blue text-white">
        Event Feed
      </div>
      <div v-if="loading" class="p-4 text-gray-500 italic">Loading events...</div>
      <div v-else-if="events.length === 0" class="p-4 text-gray-500 italic">No events to show.</div>
      <div v-for="event in events" :key="event.timestamp + event.uid"
           :class="['p-4 border-b flex items-center gap-4 hover:bg-gray-50', isFollowed(event.uid) ? 'bg-yellow-100' : '']">
        <img :src="getBoatImage(event.uid)" class="w-20 h-20 object-cover rounded" onerror="this.style.display='none'" />
        <div>
          <div class="text-lg font-semibold">{{ event.boat }}</div>
          <div class="text-sm text-gray-600">{{ event.event }} — {{ formatTime(event.timestamp) }}</div>
          <div class="text-sm">{{ event.details }}</div>
        </div>
      </div>
    </div>
  </div>

  <audio id="radio-player" hidden></audio>
</div>

<script>
const { createApp } = Vue;

const app = createApp({
  data() {
    return {
      combinedMessages: '',
      events: [],
      hooked: [],
      boatImages: {},
      tournamentLogo: '',
      version: '',
      loading: false,
      followed: JSON.parse(localStorage.getItem('followedBoats') || '[]'),
      lastEventTimestamps: new Set(),
      settings: {
        followed_sound: 'followed-activity',
        boated_sound: '1904_champagne-cork-pop-02',
        event_volume: 80,
        radio_volume: 30,
        sounds_enabled: true,
        data_source: 'live',
        tournament: ''
      },
      radioPlaying: false,
      hls: null,
      error: null,
      messageQueue: [],
      currentMessage: '',
      messageTimer: null
    };
  },
  mounted() {
    this.fetchSettings().then(() => {
      this.setupMessages();
      this.startMessageRotation();
      this.fetchVersion();
      this.loadTournamentLogo();
      this.loadParticipants();
      this.fetchAll();
      setInterval(this.fetchAll, 30000);
    });

    this.radioPlaying = localStorage.getItem('radioPlaying') === 'true';
    const player = document.getElementById('radio-player');
    if (player) player.volume = this.settings.radio_volume / 100;

    window.addEventListener('online', this.setupMessages);
    window.addEventListener('offline', this.setupMessages);
  },
  methods: {
    toggleRadio() {
  const player = document.getElementById('radio-player');
  if (!player) return;

  if (this.radioPlaying) {
    if (this.hls) this.hls.destroy();
    player.pause();
    this.radioPlaying = false;
    localStorage.setItem('radioPlaying', 'false');
    return;
  }

  fetch('/api/settings')
    .then(res => res.json())
    .then(settings => {
      const tournament = settings.tournament;
      return fetch('https://js9467.github.io/Brtourney/settings.json')
        .then(res => res.json())
        .then(all => {
          const primary = all[tournament]?.stream;
          const fallback = all[tournament]?.fallback_stream;

          const tryPlay = (url, isFallback = false) => {
            return new Promise((resolve, reject) => {
              if (!url) return reject("No stream URL");

              if (Hls.isSupported()) {
                if (this.hls) this.hls.destroy();
                this.hls = new Hls();
                this.hls.loadSource(url);
                this.hls.attachMedia(player);
                this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
                  player.volume = this.settings.radio_volume / 100;
                  player.play().then(resolve).catch(reject);
                });
              } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
                player.src = url;
                player.volume = this.settings.radio_volume / 100;
                player.play().then(resolve).catch(reject);
              } else {
                reject("HLS not supported");
              }

              // Timeout fallback
              setTimeout(() => reject("Stream timeout"), 5000);
            });
          };

          tryPlay(primary)
            .then(() => {
              this.radioPlaying = true;
              localStorage.setItem('radioPlaying', 'true');
            })
            .catch(() => {
              tryPlay(fallback, true)
                .then(() => {
                  this.radioPlaying = true;
                  localStorage.setItem('radioPlaying', 'true');
                  this.error = "Primary stream failed. Using fallback.";
                  this.enqueueMessage(this.error);
                })
                .catch(err => {
                  this.error = "🔇 Failed to play VHF stream.";
                  this.enqueueMessage(this.error);
                  console.error("Stream play failed:", err);
                });
            });
        });
    });
}

,
fetchSettings() {
      return fetch('/api/settings')
        .then(res => res.json())
        .then(data => { this.settings = { ...this.settings, ...data }; });
    },
    fetchVersion() {
      fetch('/api/version')
        .then(res => res.json())
        .then(data => { this.version = data.version; });
    },
    setupMessages() {
      this.messageQueue = [];
      if (!navigator.onLine) {
        this.enqueueMessage(`📡 Offline. <a href='/settings-page'>Connect to WiFi</a> for live event updates.`);
      }
      if (this.settings.data_source === 'demo') {
        this.enqueueMessage(`You are in demo mode. Events are emulated from a previous tournament. <a href='#' onclick='injectTestEvent()'>To simulate a boated event, click here.</a>`);
      }
      if (this.radioPlaying && this.error) {
        this.enqueueMessage(this.error);
      }
    },
    enqueueMessage(msg) {
      if (!this.messageQueue.includes(msg)) this.messageQueue.push(msg);
    },
    startMessageRotation() {
      if (this.messageQueue.length > 0 && !this.messageTimer) {
        this.currentMessage = this.messageQueue[0];
        this.messageTimer = setInterval(() => {
          this.combinedMessages = this.messageQueue.join(' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ');

        }, 8000);
      }
    },
    fetchAll() {
      this.loading = true;
      Promise.all([
        fetch('/scrape/events').then(res => res.json()),
        fetch('/hooked').then(res => res.json())
      ]).then(([eventsData, hookedData]) => {
        this.events = eventsData.events || [];
        this.hooked = hookedData.events || [];
        this.loading = false;
      }).catch(err => {
        console.error("❌ Fetch error:", err);
        this.loading = false;
      });
    },
    getBoatImage(uid) {
      return this.boatImages[uid] || '';
    },
    loadParticipants() {
  fetch('/participants_data?limit=1000&offset=0')
    .then(res => res.json())
    .then(data => {
      const images = {};
      for (const p of data.participants) {
        images[p.uid] = p.image_path;
      }

      // Inject Palmer Lou demo image from non-deletable path
      images["palmer_lou"] = "/static/images/palmer_lou.jpg";

      this.boatImages = images;
    });
}
,
    loadTournamentLogo() {
      fetch('/api/settings')
        .then(res => res.json())
        .then(settings => {
          const tournament = settings.tournament;
          return fetch('https://js9467.github.io/Brtourney/settings.json')
            .then(res => res.json())
            .then(all => {
              this.tournamentLogo = all[tournament]?.logo || '';
            });
        });
    },
    formatTime(ts) {
      const dt = new Date(ts);
      return dt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    },
    isFollowed(uid) {
      return this.followed.includes(uid);
    },
    playSound(filename) {
      const audio = new Audio(`/static/sounds/${filename}`);
      audio.volume = (this.settings.event_volume || 80) / 100;
      audio.play().catch(err => console.warn('🔇 Sound failed:', err));
    }
  }
}).mount('#app');

// Inject demo event for Palmer Lou
window.injectTestEvent = function () {
  const now = new Date();
  const future = new Date(now.getTime() + 10000).toISOString();
  const injected = {
    boat: "Palmer Lou",
    event: "Boated",
    details: "Palmer Lou has boated a massive Blue Marlin and will be heading to the scales.",
    timestamp: future,
    uid: "palmer_lou"
  };
  app.events.unshift(injected);
  app.lastEventTimestamps.add(injected.timestamp + injected.uid);
  app.playSound(app.settings.boated_sound);
};
</script>
</body>
</html>
