<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Events Feed</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.8/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/css/base.css">
  <style>
    body { touch-action: manipulation; }
    .toast {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 9999;
      padding: 0.75rem 1rem;
      border-radius: 0.375rem;
      font-weight: 600;
      color: white;
    }
    .toast-success { background-color: #16a34a; }
    .toast-error { background-color: #dc2626; }
    .vhf-indicator {
      display: inline-block;
      margin-left: 8px;
      width: 10px;
      height: 10px;
      background-color: #16a34a;
      border-radius: 50%;
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0%, 50%, 100% { opacity: 1; }
      25%, 75% { opacity: 0; }
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans">
<div id="app">
  <!-- Header -->
  <header class="bg-brand-blue text-white flex items-center justify-between px-4 py-3 shadow-md">
    <div class="flex items-center space-x-4">
      <img v-if="tournamentLogo" :src="tournamentLogo" alt="Tournament Logo" class="h-14 drop-shadow">
      <span v-else class="text-white text-base">Loading Logo...</span>
    </div>
    <div class="flex items-center space-x-4">
      <button @click="toggleRadio" class="bg-white text-brand-blue px-4 py-2 rounded font-bold">
        {{ radioPlaying ? 'VHF On' : 'VHF Off' }}
        <span v-if="radioPlaying" class="vhf-indicator"></span>
      </button>
      <a href="/leaderboard.html" class="bg-brand-gold text-white px-4 py-2 rounded font-bold">Leaderboard</a>
      <a href="/settings.html" class="bg-gray-300 text-brand-blue px-4 py-2 rounded font-bold">Settings</a>
    </div>
  </header>

  <!-- Main Feed -->
  <main class="p-4 space-y-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Hooked Up Feed -->
      <div class="col-span-1">
        <h2 class="text-lg font-bold mb-2">Hooked Up</h2>
        <div v-if="hooked.length === 0" class="text-gray-500">No boats currently hooked up</div>
        <div v-for="event in hooked" :key="event.id" class="bg-white p-3 rounded shadow">
          <img v-if="boatImages[event.uid]" :src="boatImages[event.uid]" class="h-32 w-full object-cover rounded mb-2">
          <p class="font-bold text-brand-blue">{{ event.boat }}</p>
          <p class="text-sm text-gray-600">{{ event.time }}</p>
        </div>
      </div>

      <!-- Main Event Feed -->
      <div class="col-span-2">
        <h2 class="text-lg font-bold mb-2">Live Events</h2>
        <div v-if="loading" class="text-gray-500">Loading events...</div>
        <div v-for="event in events" :key="event.id" class="bg-white p-3 rounded shadow flex items-center justify-between">
          <div>
            <p class="font-bold">{{ event.boat }}</p>
            <p class="text-sm text-gray-600">{{ event.time }} ‚Äî {{ event.details }}</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div v-if="toastMessage" :class="['toast', toastType]">{{ toastMessage }}</div>
  <audio ref="audioPlayer" preload="auto"></audio>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      events: [],
      hooked: [],
      boatImages: {},
      loading: true,
      toastMessage: '',
      toastType: '',
      radioPlaying: false,
      hls: null,
      settings: {},
      tournamentLogo: null,
      primaryStream: '',
      fallbackStream: ''
    };
  },
  methods: {
    async fetchSettings() {
      const res = await axios.get('/api/settings');
      this.settings = res.data;
      const tournament = this.settings.tournament;
      const remote = await axios.get('https://js9467.github.io/Brtourney/settings.json');
      const tournamentEntry = remote.data[tournament] || {};
      this.primaryStream = tournamentEntry.stream || '';
      this.fallbackStream = remote.data.fallback_stream || '';
      this.tournamentLogo = tournamentEntry.logo || null;
    },
    async fetchEvents() {
      const res = await axios.get('/events');
      this.events = res.data;
    },
    async fetchHooked() {
      const res = await axios.get('/hooked');
      this.hooked = res.data;
    },
    async fetchImages() {
      const res = await axios.get('/participants');
      res.data.forEach(p => {
        this.boatImages[p.uid] = p.image_path;
      });
    },
    showToast(msg, type = 'toast-success') {
      this.toastMessage = msg;
      this.toastType = type;
      setTimeout(() => this.toastMessage = '', 3000);
    },
    toggleRadio() {
      const player = this.$refs.audioPlayer;
      const playStream = (url, isFallback = false) => {
        if (this.hls) {
          this.hls.destroy();
          this.hls = null;
        }

        if (Hls.isSupported()) {
          this.hls = new Hls();
          this.hls.loadSource(url);
          this.hls.attachMedia(player);
          this.hls.on(Hls.Events.MANIFEST_PARSED, () => {
            player.volume = this.settings.radio_volume || 0.3;
            player.play()
              .then(() => {
                this.radioPlaying = true;
                this.showToast('üì° VHF Stream Playing');
              })
              .catch(err => {
                console.error('üîä HLS play failed:', err);
                if (!isFallback && this.fallbackStream) {
                  playStream(this.fallbackStream, true);
                } else {
                  this.showToast('üîá Stream unavailable', 'toast-error');
                }
              });
          });
        } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
          player.src = url;
          player.volume = this.settings.radio_volume || 0.3;
          player.play().then(() => {
            this.radioPlaying = true;
            this.showToast('üì° VHF Stream Playing');
          }).catch(err => {
            console.error('üîä Native HLS play failed:', err);
            if (!isFallback && this.fallbackStream) {
              playStream(this.fallbackStream, true);
            } else {
              this.showToast('üîá Stream unavailable', 'toast-error');
            }
          });
        } else {
          this.showToast('‚ùå Audio format not supported', 'toast-error');
        }
      };

      if (this.radioPlaying) {
        if (this.hls) {
          this.hls.destroy();
          this.hls = null;
        }
        player.pause();
        player.src = '';
        this.radioPlaying = false;
        this.showToast('üõë VHF Stream Stopped', 'toast-info');
      } else {
        player.src = '';
        playStream(this.primaryStream || this.fallbackStream);
      }
    }
  },
  async mounted() {
    await this.fetchSettings();
    await this.fetchImages();
    await this.fetchEvents();
    await this.fetchHooked();
    setInterval(this.fetchEvents, 30000);
    setInterval(this.fetchHooked, 30000);
  }
}).mount("#app");
</script>
</body>
</html>