<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Join a Wi-Fi Network for Tournament Updates</title>
  <link rel="stylesheet" href="/static/css/base.css">
  <style>
    :root{
      --brand-blue: #0a2146;
      --brand-gold: #d4af37;
      --bg: #0b1220;
      --card: #101a2e;
      --card-border: #1e2b4a;
      --text: #e8eefc;
      --muted: #a9b7d9;
      --success: #35b36a;
      --focus: #4c86ff;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin:0; font-family: Barlow, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    body { background: var(--bg); color: var(--text); display:flex; flex-direction:column; }

    /* Simple header (text only) */
    .header{
      background: var(--brand-blue);
      color: #fff;
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 16px; border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .header h1{ margin:0; font-size:1.1rem; font-weight:700; letter-spacing:.2px; }
    .header p{ margin:.25rem 0 0; color:#d7def2; font-size:.92rem; }
    .header .right{ display:flex; gap:8px; align-items:center; }
    .btn{
      background: #152342; color:#fff; border:1px solid rgba(255,255,255,0.12);
      padding: 8px 12px; border-radius: 10px; font-weight:600; cursor:pointer;
    }
    .btn:focus{ outline:2px solid var(--focus); outline-offset:2px; }
    .btn.primary{ background: var(--brand-blue); }

    /* Layout: list + feature image */
    .wrap{ width:100%; max-width:1080px; margin:0 auto; padding: 18px 16px 28px; }
    .grid{
      display:grid; grid-template-columns: 1.2fr .8fr; gap:16px;
    }
    @media (max-width: 840px){
      .grid{ grid-template-columns: 1fr; }
    }

    .notice{
      background: rgba(212,175,55,0.08);
      border: 1px solid rgba(212,175,55,0.3);
      color: #ffe7a6;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 14px;
    }

    /* Network list */
    .list{ display:grid; gap:10px; }
    .card{
      background: var(--card); border:1px solid var(--card-border);
      border-radius:14px; padding:12px; display:grid; gap:10px;
    }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .ssid{ display:flex; align-items:center; gap:10px; font-weight:700; }
    .badge{
      font-size:.78rem; padding:4px 8px; border-radius:999px;
      background:#121c31; border:1px solid var(--card-border); color: var(--muted);
    }
    .badge.connected{ color:#c9f7dc; border-color: rgba(53,179,106,0.35); background: rgba(53,179,106,0.1); }
    .badge.secured{ color:#e0defd; border-color: rgba(125,102,240,0.35); background: rgba(125,102,240,0.10); }

    /* Signal bars */
    .bars{ display:inline-flex; align-items:flex-end; gap:3px; margin-right:6px; }
    .bar{ width:4px; height:6px; background:#415378; border-radius:2px; opacity:.6; }
    .bar.on{ background:#a6c3ff; opacity:1; }
    .bar.b2{ height:9px; } .bar.b3{ height:12px; } .bar.b4{ height:15px; } .bar.b5{ height:18px; }

    /* Form */
    .form{ display:grid; gap:8px; }
    .input{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; }
    .text{
      width:100%; padding:10px 12px; border-radius:10px; background:#0c152a;
      border:1px solid var(--card-border); color:var(--text);
    }
    .toggle-eye{
      width:42px; height:42px; border-radius:10px; border:1px solid var(--card-border);
      background:#12203f; color:#cdd9f6; cursor:pointer; display:grid; place-items:center; font-size:18px; user-select:none;
    }
    .show-pass{ display:flex; align-items:center; gap:8px; color:var(--muted); font-size:.92rem; }

    .status{ color:var(--muted); text-align:center; margin-top:6px; min-height:1.2em; }
    .spinner{ width:14px; height:14px; border:2px solid rgba(255,255,255,0.25); border-top-color:#fff; border-radius:50%; animation:spin 1s linear infinite; display:inline-block; }
    @keyframes spin { to{ transform:rotate(360deg);} }

    /* Feature image card (Palmer Lou) */
    .feature{
      background: var(--card);
      border:1px solid var(--card-border);
      border-radius: 16px;
      overflow: hidden;
    }
    .feature .imagewrap{
      position: relative;
      width: 100%;
      aspect-ratio: 16/10;
      background: #0d1730;
    }
    .feature picture, .feature img{
      width:100%; height:100%; object-fit: cover; display:block;
      opacity: 0; transform: scale(1.02);
      transition: opacity 600ms ease, transform 1200ms ease;
    }
    .feature img.loaded{ opacity: 1; transform: scale(1); }
    .feature .caption{
      padding: 10px 12px; color: var(--muted); font-size: .9rem;
      border-top: 1px solid var(--card-border);
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div>
      <h1>Join a Wi-Fi Network for Live Tournament Updates</h1>
      <p>You’re currently offline. Connect below to resume real-time feeds.</p>
    </div>
    <div class="right">
      <button class="btn" id="btn-scan" type="button" title="Scan">Scan</button>
      <button class="btn" id="btn-refresh" type="button" title="Refresh">Refresh</button>
    </div>
  </header>

  <main class="wrap">
    <div class="notice">Tip: Saved networks won’t ask for a password again. You can also <strong>show the password</strong> while typing.</div>

    <section class="grid">
      <!-- Left: networks -->
      <div>
        <div class="list" id="networks" role="list">
          <div class="card"><span class="spinner"></span> Scanning for nearby networks…</div>
        </div>
        <div class="status" id="status" aria-live="polite"></div>
      </div>

      <!-- Right: classy Palmer Lou feature -->
      <aside class="feature" aria-label="Palmer Lou">
        <div class="imagewrap">
          <picture>
            <source srcset="/static/images/palmer_lou.webp" type="image/webp">
            <img id="palmerImg" src="/static/images/palmer_lou.jpg" alt="Palmer Lou">
          </picture>
        </div>
        <div class="caption">Palmer Lou — Big Rock vibes while you connect.</div>
      </aside>
    </section>
  </main>

  <script>
    // Fade-in the Palmer Lou image when it finishes loading
    (function(){
      const img = document.getElementById('palmerImg');
      if (!img) return;
      if (img.complete) img.classList.add('loaded');
      else img.addEventListener('load', () => img.classList.add('loaded'));
    })();

    // ---------- Scan / render controls with pause while form open ----------
    let scanTimer = null;
    let scanningPaused = false;   // set true while password form is open
    let activeSSID = null;        // current form's SSID

    const networksEl = document.getElementById('networks');
    const statusEl   = document.getElementById('status');

    function el(tag, props = {}, children = []) {
      const n = document.createElement(tag);
      Object.assign(n, props);
      (children || []).forEach(c => n.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));
      return n;
    }

    function barsFor(signal){
      const s = Math.max(0, Math.min(100, signal || 0));
      const lvl = s>=80?5 : s>=60?4 : s>=40?3 : s>=20?2 : s>0?1 : 0;
      const wrap = el('span', { className:'bars', title: s + '%' });
      for(let i=1;i<=5;i++){
        const b = el('span', { className:`bar b${i} ${i<=lvl?'on':''}` });
        wrap.appendChild(b);
      }
      return wrap;
    }

    function indicateKeyboard(input){
      input.addEventListener('focus', () => fetch('/launch_keyboard', { method:'POST' }).catch(()=>{}));
      input.addEventListener('blur',  () => fetch('/hide_keyboard',   { method:'POST' }).catch(()=>{}));
    }

    function dedupeSortNetworks(networks){
      const map = new Map();
      (networks||[]).forEach(n=>{
        const key = (n.ssid||'').trim();
        if(!key) return;
        const prev = map.get(key);
        if(!prev || (n.signal||0) > (prev.signal||0) || (n.connected && !prev.connected)){
          map.set(key, n);
        }
      });
      return Array.from(map.values()).sort((a,b)=>{
        if(!!b.connected - !!a.connected) return 1 * (!!b.connected - !!a.connected);
        return (b.signal||0) - (a.signal||0);
      });
    }

    function renderNetworks(list){
      // If a form is open, do not re-render the list (prevents closing while typing)
      if (scanningPaused) return;

      networksEl.innerHTML = '';
      if(!list || list.length === 0){
        networksEl.appendChild(el('div', { className:'card' }, ['No networks found.']));
        return;
      }

      list.forEach(net=>{
        const card = el('div', { className:'card', role:'listitem' });
        const left = el('div', { className:'ssid' }, [ barsFor(net.signal||0), el('span', { textContent: net.ssid }) ]);
        const tags = el('div', {}, [
          net.connected ? el('span', { className:'badge connected', textContent:'Connected' }) : null,
          net.secured ? el('span', { className:'badge secured', textContent:'Secured' }) : el('span', { className:'badge', textContent:'Open' })
        ].filter(Boolean));

        const actions = el('div', {}, []);
        if (net.connected){
          const b = el('button', { className:'btn', textContent:'Disconnect' });
          b.onclick = () => disconnect(net.ssid);
          actions.appendChild(b);
        } else {
          const b = el('button', { className:'btn primary', textContent:'Connect' });
          b.onclick = () => showConnectForm(card, net);
          actions.appendChild(b);
        }

        const row = el('div', { className:'row' }, [ el('div', { className:'row' }, [left, tags]), actions ]);
        card.appendChild(row);
        networksEl.appendChild(card);
      });
    }

    function showConnectForm(card, net){
      scanningPaused = true;
      activeSSID = net.ssid;

      card.innerHTML = '';
      const title = el('div', { className:'row' }, [
        el('div', { className:'ssid' }, [ barsFor(net.signal||0), el('span', { textContent: net.ssid }) ]),
        el('span', { className:`badge ${net.secured?'secured':''}`, textContent: net.secured ? 'Secured' : 'Open' })
      ]);
      card.appendChild(title);

      const form = el('div', { className:'form' });

      const pwInput = el('input', {
        className:'text',
        type: net.secured ? 'password' : 'text',
        placeholder: net.secured ? 'Network password' : 'No password required',
        disabled: !net.secured
      });
      indicateKeyboard(pwInput);

      const eyeBtn = el('button', { className:'toggle-eye', type:'button', title:'Show/Hide password' }, ['👁']);
      eyeBtn.onclick = () => { pwInput.type = pwInput.type === 'password' ? 'text' : 'password'; pwInput.focus(); };

      const inputRow = el('div', { className:'input' }, [ pwInput, eyeBtn ]);
      form.appendChild(inputRow);

      const showWrap = el('label', { className:'show-pass' });
      const showCb   = el('input', { type:'checkbox' });
      const showTxt  = el('span', { textContent:'Show password while typing' });
      showCb.addEventListener('change', () => { pwInput.type = showCb.checked ? 'text' : 'password'; pwInput.focus(); });
      showWrap.appendChild(showCb); showWrap.appendChild(showTxt);
      form.appendChild(showWrap);

      const actions = el('div', { className:'row' }, [
        el('button', { className:'btn', textContent:'Back' }),
        el('button', { className:'btn primary', textContent: net.secured ? 'Join' : 'Join (Open)' })
      ]);
      actions.children[0].onclick = () => { scanningPaused = false; activeSSID = null; scan(); };
      actions.children[1].onclick = () => connect(net.ssid, net.secured ? pwInput.value : '');
      form.appendChild(actions);

      card.appendChild(form);
      if(net.secured) pwInput.focus();
    }

    async function scan(){
      if (scanningPaused) return; // don’t interrupt typing
      try{
        const res = await fetch('/wifi/scan');
        const data = await res.json();
        const cleaned = dedupeSortNetworks(data.networks || []);
        renderNetworks(cleaned);
      }catch(e){
        networksEl.innerHTML = '';
        networksEl.appendChild(el('div', { className:'card' }, ['Scan failed.']));
      }
    }

    async function connect(ssid, password){
      try{
        statusEl.innerHTML = '<span class="spinner"></span> Connecting…';
        // Keep paused until we finish attempt
        scanningPaused = true;
        const res = await fetch('/wifi/connect', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ ssid, password: password || '' })
        });
        const data = await res.json();
        statusEl.textContent = data.message || data.status || '';
        if(data.status === 'ok'){
          setTimeout(() => window.location.replace('/'), 1500);
        }else{
          // Allow user to try again without closing the form
          scanningPaused = true; // remain paused since the form is still open
        }
      }catch(e){
        statusEl.textContent = 'Connection failed.';
        scanningPaused = true; // keep the form open
      }
    }

    async function disconnect(ssid){
      try{
        statusEl.innerHTML = '<span class="spinner"></span> Disconnecting…';
        const res = await fetch('/wifi/disconnect', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ ssid })
        });
        const data = await res.json();
        statusEl.textContent = data.message || data.status || '';
        scan();
      }catch(e){
        statusEl.textContent = 'Disconnect failed.';
      }
    }

    // Online -> return to app
    window.addEventListener('online', () => window.location.replace('/'));

    // Buttons / timers
    document.getElementById('btn-scan').onclick = () => { if(!scanningPaused) scan(); };
    document.getElementById('btn-refresh').onclick = () => { if(!scanningPaused) scan(); };

    // Start scanning
    scan();
    scanTimer = setInterval(()=>{ if(!scanningPaused) scan(); }, 15000);
  </script>
</body>
</html>
