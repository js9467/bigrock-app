<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Please connect to a network for tournament updates</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/css/base.css">
</head>
<body class="bg-gray-100 text-brand-blue flex flex-col items-center justify-center min-h-screen p-4">
  <h1 class="text-2xl font-bold mb-4">Offline</h1>
  <p class="mb-6 text-center">No network connection detected. Select a Wi-Fi network to connect.</p>
  <div id="networks" class="w-full max-w-md space-y-2 text-left">Scanning...</div>
  <div id="status" class="mt-4 text-center"></div>

  <script>
    async function scan() {
      try {
        const res = await fetch('/wifi/scan');
        const data = await res.json();
        const container = document.getElementById('networks');
        container.innerHTML = '';
        if (!data.networks || data.networks.length === 0) {
          container.textContent = 'No networks found.';
          return;
        }
        data.networks.forEach(net => {
          const row = document.createElement('div');
          row.className = 'flex items-center gap-2';

          const label = document.createElement('span');
          label.textContent = `${net.ssid} (${net.signal}%)`;
          row.appendChild(label);

          if (net.connected) {
            const tag = document.createElement('span');
            tag.textContent = 'Connected';
            tag.className = 'text-green-600 font-semibold';
            row.appendChild(tag);
          } else {
            const btn = document.createElement('button');
            btn.textContent = 'Connect';
            btn.className = 'px-3 py-1 bg-brand-blue text-white rounded';
            btn.onclick = () => showConnectForm(net.ssid, row);
            row.appendChild(btn);
          }
          container.appendChild(row);
        });
      } catch (e) {
        document.getElementById('networks').textContent = 'Scan failed.';
      }
    }

    function showConnectForm(ssid, row) {
      row.innerHTML = '';
      row.className = 'flex items-center gap-2';

      const label = document.createElement('span');
      label.textContent = ssid;
      row.appendChild(label);

      const input = document.createElement('input');
      input.type = 'password';
      input.placeholder = 'Password (leave blank if open)';
      input.className = 'border px-2 py-1 flex-1 rounded';
      input.addEventListener('focus', () => fetch('/launch_keyboard', { method: 'POST' }).catch(() => {}));
      input.addEventListener('blur', () => fetch('/hide_keyboard', { method: 'POST' }).catch(() => {}));
      row.appendChild(input);

      const btn = document.createElement('button');
      btn.textContent = 'Join';
      btn.className = 'px-3 py-1 bg-brand-blue text-white rounded';
      btn.onclick = () => connect(ssid, input.value);
      row.appendChild(btn);

      input.focus();
    }

    async function connect(ssid, password) {
      const res = await fetch('/wifi/connect', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ssid, password: password || '' })
      });
      const data = await res.json();
      document.getElementById('status').textContent = data.message || data.status;
      if (data.status === 'ok') {
        setTimeout(() => window.location.replace('/'), 2000);
      }
    }

    window.addEventListener('online', () => window.location.replace('/'));
    scan();
    setInterval(scan, 15000);
  </script>
</body>
</html>

