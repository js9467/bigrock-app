<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Join a Wi-Fi Network for Tournament Updates</title>
  <link rel="stylesheet" href="/static/css/base.css">
  <style>
    :root{
      --brand-blue: #0a2146;
      --brand-gold: #d4af37;
      --bg: #0b1220;
      --card: #101a2e;
      --card-border: #1e2b4a;
      --text: #e8eefc;
      --muted: #a9b7d9;
      --success: #35b36a;
      --focus: #4c86ff;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin:0; font-family: Barlow, sans-serif; }
    body { background: var(--bg); color: var(--text); display: flex; flex-direction: column; }

    /* Banner with Palmer Lou */
    .banner {
      position: relative;
      width: 100%;
      height: 180px;
      overflow: hidden;
    }
    .banner picture, .banner img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .banner::after {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.45);
    }
    .banner-text {
      position: absolute;
      bottom: 12px;
      left: 16px;
      color: white;
      z-index: 1;
    }
    .banner-text h1 {
      font-size: 1.5rem;
      margin: 0;
      font-weight: 700;
    }
    .banner-text p {
      font-size: 0.95rem;
      margin: 4px 0 0;
      color: #ddd;
    }

    /* Content */
    .wrap { width: 100%; max-width: 840px; margin: 0 auto; padding: 18px 16px 28px; display: flex; flex-direction: column; gap: 14px; }
    .notice { background: rgba(212,175,55,0.08); border: 1px solid rgba(212,175,55,0.3); color: #ffe7a6; border-radius: 12px; padding: 10px 12px; font-weight: 600; text-align: center; }

    /* Network list */
    .list { display: grid; gap: 10px; }
    .card { background: var(--card); border: 1px solid var(--card-border); border-radius: 14px; padding: 12px; display: grid; gap: 10px; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; flex-wrap: wrap; }
    .ssid { display: flex; align-items: center; gap: 10px; font-weight: 700; }
    .badge { font-size: 0.78rem; padding: 4px 8px; border-radius: 999px; background:#121c31; border: 1px solid var(--card-border); color: var(--muted); }
    .badge.connected { color: #c9f7dc; border-color: rgba(53,179,106,0.35); background: rgba(53,179,106,0.1); }
    .btn { background: var(--brand-blue); color: #fff; border: none; padding: 8px 14px; border-radius: 12px; font-weight: 600; cursor: pointer; }
    .text { width: 100%; padding: 8px 12px; border-radius: 10px; background: #0c152a; border:1px solid var(--card-border); color: var(--text); }
    .toggle-eye { margin-left: 6px; padding: 6px 10px; background: #12203f; border:1px solid var(--card-border); border-radius: 8px; color: #cdd9f6; cursor:pointer; }
    .show-pass { display:flex; align-items:center; gap:8px; color: var(--muted); font-size:0.9rem; }

    .status{ color: var(--muted); text-align: center; margin-top: 6px; min-height: 1.2em; }
    .spinner{ width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.25); border-top-color:#fff; border-radius: 50%; animation: spin 1s linear infinite; display:inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <!-- Banner with Palmer Lou image -->
  <div class="banner">
    <picture>
      <source srcset="/static/images/palmer_lou.webp" type="image/webp">
      <img src="/static/images/palmer_lou.jpg" alt="Palmer Lou">
    </picture>
    <div class="banner-text">
      <h1>Join a Wi-Fi Network</h1>
      <p>Stay connected for live tournament updates</p>
    </div>
  </div>

  <!-- Content -->
  <main class="wrap">
    <div class="notice">Tip: Saved networks won’t ask for a password again. You can also show the password while typing.</div>
    <div class="list" id="networks">Scanning...</div>
    <div class="status" id="status"></div>
  </main>

  <script>
    function indicateKeyboard(input){
      input.addEventListener('focus', () => fetch('/launch_keyboard',{method:'POST'}).catch(()=>{}));
      input.addEventListener('blur', () => fetch('/hide_keyboard',{method:'POST'}).catch(()=>{}));
    }
    function showConnectForm(row, ssid){
      row.innerHTML = '';
      const label = document.createElement('span');
      label.textContent = ssid;
      row.appendChild(label);

      const input = document.createElement('input');
      input.type = 'password';
      input.placeholder = 'Password (leave blank if open)';
      input.className = 'text';
      indicateKeyboard(input);
      row.appendChild(input);

      const eye = document.createElement('button');
      eye.textContent = '👁';
      eye.type = 'button';
      eye.className = 'toggle-eye';
      eye.onclick = () => { input.type = input.type === 'password' ? 'text' : 'password'; };
      row.appendChild(eye);

      const showWrap = document.createElement('label');
      showWrap.className = 'show-pass';
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.onchange = () => { input.type = cb.checked ? 'text' : 'password'; };
      showWrap.appendChild(cb);
      showWrap.appendChild(document.createTextNode('Show password while typing'));
      row.appendChild(showWrap);

      const btn = document.createElement('button');
      btn.textContent = 'Join';
      btn.className = 'btn';
      btn.onclick = () => connect(ssid, input.value);
      row.appendChild(btn);

      input.focus();
    }
    async function scan(){
      try {
        const res = await fetch('/wifi/scan');
        const data = await res.json();
        const container = document.getElementById('networks');
        container.innerHTML = '';
        if (!data.networks || !data.networks.length){
          container.textContent = 'No networks found.';
          return;
        }
        data.networks.forEach(net => {
          const row = document.createElement('div');
          row.className = 'card row';
          const label = document.createElement('span');
          label.className = 'ssid';
          label.textContent = `${net.ssid} (${net.signal}%)`;
          row.appendChild(label);
          if (net.connected){
            const tag = document.createElement('span');
            tag.className = 'badge connected';
            tag.textContent = 'Connected';
            row.appendChild(tag);
          } else {
            const btn = document.createElement('button');
            btn.className = 'btn';
            btn.textContent = 'Connect';
            btn.onclick = () => showConnectForm(row, net.ssid);
            row.appendChild(btn);
          }
          container.appendChild(row);
        });
      } catch {
        document.getElementById('networks').textContent = 'Scan failed.';
      }
    }
    async function connect(ssid, password){
      const res = await fetch('/wifi/connect',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ ssid, password: password || '' })
      });
      const data = await res.json();
      document.getElementById('status').textContent = data.message || data.status;
      if(data.status === 'ok'){
        setTimeout(() => window.location.replace('/'), 2000);
      }
    }
    window.addEventListener('online', () => window.location.replace('/'));
    scan();
    setInterval(scan, 15000);
  </script>
</body>
</html>
